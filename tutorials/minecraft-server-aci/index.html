<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.68.3"><meta name=description content="Farmer - Making repeatable Azure deployments easy!"><link rel=icon href=/farmer/images/farmer-favicon.png type=image/png><title>Create your own Minecraft Server :: Farmer</title><link href=/farmer/css/nucleus.css?1633543444 rel=stylesheet><link href=/farmer/css/fontawesome-all.min.css?1633543444 rel=stylesheet><link href=/farmer/css/hybrid.css?1633543444 rel=stylesheet><link href=/farmer/css/featherlight.min.css?1633543444 rel=stylesheet><link href=/farmer/css/perfect-scrollbar.min.css?1633543444 rel=stylesheet><link href=/farmer/css/auto-complete.css?1633543444 rel=stylesheet><link href=/farmer/css/atom-one-dark-reasonable.css?1633543444 rel=stylesheet><link href=/farmer/css/theme.css?1633543444 rel=stylesheet><link href=/farmer/css/hugo-theme.css?1633543444 rel=stylesheet><link href=/farmer/css/theme-green.css?1633543444 rel=stylesheet><script src=/farmer/js/jquery-3.3.1.min.js?1633543444></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/farmer/tutorials/minecraft-server-aci/><nav id=sidebar><div id=header-wrapper><div id=header><img src=/farmer/images/logo.png></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label><input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/farmer/js/lunr.min.js?1633543444></script><script type=text/javascript src=/farmer/js/auto-complete.js?1633543444></script><script type=text/javascript>var baseurl="https:\/\/compositionalit.github.io\/farmer\/";</script><script type=text/javascript src=/farmer/js/search.js?1633543444></script></div><div class=highlightable><ul class=topics><li data-nav-id=/farmer/about/ title=About class=dd-item><a href=/farmer/about/>About</a></li><li data-nav-id=/farmer/quickstarts/ title=Quickstarts class=dd-item><a href=/farmer/quickstarts/>Quickstarts</a><ul><li data-nav-id=/farmer/quickstarts/quickstart-1/ title="Your first Farmer template" class=dd-item><a href=/farmer/quickstarts/quickstart-1/>Your first Farmer template</a></li><li data-nav-id=/farmer/quickstarts/quickstart-2/ title="Working with multiple resources" class=dd-item><a href=/farmer/quickstarts/quickstart-2/>Working with multiple resources</a></li><li data-nav-id=/farmer/quickstarts/quickstart-3/ title="Deploying to Azure" class=dd-item><a href=/farmer/quickstarts/quickstart-3/>Deploying to Azure</a></li><li data-nav-id=/farmer/quickstarts/template/ title="The Farmer .NET Template" class=dd-item><a href=/farmer/quickstarts/template/>The Farmer .NET Template</a></li></ul></li><li data-nav-id=/farmer/tutorials/ title=Tutorials class="dd-item
parent"><a href=/farmer/tutorials/>Tutorials</a><ul><li data-nav-id=/farmer/tutorials/traditional-ea/ title="Traditional Enterprise Application to the Azure Cloud, managed via Farmer" class=dd-item><a href=/farmer/tutorials/traditional-ea/>Traditional Enterprise Application to the Azure Cloud, managed via Farmer</a></li><li data-nav-id=/farmer/tutorials/webapp-deploy/ title="Deploy an ASP.NET app" class=dd-item><a href=/farmer/tutorials/webapp-deploy/>Deploy an ASP.NET app</a></li><li data-nav-id=/farmer/tutorials/custom-output/ title="Custom Output with ARM Expressions" class=dd-item><a href=/farmer/tutorials/custom-output/>Custom Output with ARM Expressions</a></li><li data-nav-id=/farmer/tutorials/keyvault-certs/ title="Declarative Steps in an ARM Deployment" class=dd-item><a href=/farmer/tutorials/keyvault-certs/>Declarative Steps in an ARM Deployment</a></li><li data-nav-id=/farmer/tutorials/minecraft-server-aci/ title="Create your own Minecraft Server" class="dd-item active"><a href=/farmer/tutorials/minecraft-server-aci/>Create your own Minecraft Server</a></li><li data-nav-id=/farmer/tutorials/aci-fsx/ title="F# Script in a Container Group" class=dd-item><a href=/farmer/tutorials/aci-fsx/>F# Script in a Container Group</a></li><li data-nav-id=/farmer/tutorials/cosmos-backed-webapp/ title="Cosmos-backed Web App" class=dd-item><a href=/farmer/tutorials/cosmos-backed-webapp/>Cosmos-backed Web App</a></li><li data-nav-id=/farmer/tutorials/multiple-web-apps/ title="Multiple web apps" class=dd-item><a href=/farmer/tutorials/multiple-web-apps/>Multiple web apps</a></li><li data-nav-id=/farmer/tutorials/serverless-etl/ title="Serverless ETL" class=dd-item><a href=/farmer/tutorials/serverless-etl/>Serverless ETL</a></li><li data-nav-id=/farmer/tutorials/web-storage-keyvault/ title="Web App Secrets with KeyVault" class=dd-item><a href=/farmer/tutorials/web-storage-keyvault/>Web App Secrets with KeyVault</a></li></ul></li><li data-nav-id=/farmer/api-overview/ title="API Overview" class=dd-item><a href=/farmer/api-overview/>API Overview</a><ul><li data-nav-id=/farmer/api-overview/template-generation/ title="Generating templates" class=dd-item><a href=/farmer/api-overview/template-generation/>Generating templates</a></li><li data-nav-id=/farmer/api-overview/expressions/ title="ARM Expressions" class=dd-item><a href=/farmer/api-overview/expressions/>ARM Expressions</a></li><li data-nav-id=/farmer/api-overview/parameters/ title="Parameters and Variables" class=dd-item><a href=/farmer/api-overview/parameters/>Parameters and Variables</a></li><li data-nav-id=/farmer/api-overview/dependencies/ title=Dependencies class=dd-item><a href=/farmer/api-overview/dependencies/>Dependencies</a></li><li data-nav-id=/farmer/api-overview/outputs/ title=Outputs class=dd-item><a href=/farmer/api-overview/outputs/>Outputs</a></li><li data-nav-id=/farmer/api-overview/resources/ title=Resources class=dd-item><a href=/farmer/api-overview/resources/>Resources</a><ul><li data-nav-id=/farmer/api-overview/resources/alert/ title="App Insights - Alerts" class=dd-item><a href=/farmer/api-overview/resources/alert/>App Insights - Alerts</a></li><li data-nav-id=/farmer/api-overview/resources/dashboard/ title=Dashboard class=dd-item><a href=/farmer/api-overview/resources/dashboard/>Dashboard</a></li><li data-nav-id=/farmer/api-overview/resources/availability-tests/ title="App Insights - Availability Tests" class=dd-item><a href=/farmer/api-overview/resources/availability-tests/>App Insights - Availability Tests</a></li><li data-nav-id=/farmer/api-overview/resources/resource-group/ title="Resource Group" class=dd-item><a href=/farmer/api-overview/resources/resource-group/>Resource Group</a></li><li data-nav-id=/farmer/api-overview/resources/aks-cluster/ title="AKS Cluster" class=dd-item><a href=/farmer/api-overview/resources/aks-cluster/>AKS Cluster</a></li><li data-nav-id=/farmer/api-overview/resources/app-insights/ title="App Insights" class=dd-item><a href=/farmer/api-overview/resources/app-insights/>App Insights</a></li><li data-nav-id=/farmer/api-overview/resources/communication-services/ title="Communication Services" class=dd-item><a href=/farmer/api-overview/resources/communication-services/>Communication Services</a></li><li data-nav-id=/farmer/api-overview/resources/bing-search/ title="Bing Search" class=dd-item><a href=/farmer/api-overview/resources/bing-search/>Bing Search</a></li><li data-nav-id=/farmer/api-overview/resources/bastion-host/ title="Bastion Host" class=dd-item><a href=/farmer/api-overview/resources/bastion-host/>Bastion Host</a></li><li data-nav-id=/farmer/api-overview/resources/container-group/ title="Container Group" class=dd-item><a href=/farmer/api-overview/resources/container-group/>Container Group</a></li><li data-nav-id=/farmer/api-overview/resources/container-registry/ title="Container Registry" class=dd-item><a href=/farmer/api-overview/resources/container-registry/>Container Registry</a></li><li data-nav-id=/farmer/api-overview/resources/cognitive-services/ title="Cognitive Services" class=dd-item><a href=/farmer/api-overview/resources/cognitive-services/>Cognitive Services</a></li><li data-nav-id=/farmer/api-overview/resources/cosmos-db/ title="Cosmos DB" class=dd-item><a href=/farmer/api-overview/resources/cosmos-db/>Cosmos DB</a></li><li data-nav-id=/farmer/api-overview/resources/cdn/ title=CDN class=dd-item><a href=/farmer/api-overview/resources/cdn/>CDN</a></li><li data-nav-id=/farmer/api-overview/resources/databricks-workspace/ title="Databricks Workspace" class=dd-item><a href=/farmer/api-overview/resources/databricks-workspace/>Databricks Workspace</a></li><li data-nav-id=/farmer/api-overview/resources/deployment-script/ title="Deployment Script" class=dd-item><a href=/farmer/api-overview/resources/deployment-script/>Deployment Script</a></li><li data-nav-id=/farmer/api-overview/resources/dns/ title="DNS Zone" class=dd-item><a href=/farmer/api-overview/resources/dns/>DNS Zone</a></li><li data-nav-id=/farmer/api-overview/resources/data-lake/ title="Data Lake" class=dd-item><a href=/farmer/api-overview/resources/data-lake/>Data Lake</a></li><li data-nav-id=/farmer/api-overview/resources/diagnosticsetting/ title="Diagnostic Settings" class=dd-item><a href=/farmer/api-overview/resources/diagnosticsetting/>Diagnostic Settings</a></li><li data-nav-id=/farmer/api-overview/resources/event-grid/ title="Event Grid" class=dd-item><a href=/farmer/api-overview/resources/event-grid/>Event Grid</a></li><li data-nav-id=/farmer/api-overview/resources/express-route/ title=ExpressRoute class=dd-item><a href=/farmer/api-overview/resources/express-route/>ExpressRoute</a></li><li data-nav-id=/farmer/api-overview/resources/event-hub/ title="Event Hub" class=dd-item><a href=/farmer/api-overview/resources/event-hub/>Event Hub</a></li><li data-nav-id=/farmer/api-overview/resources/functions/ title=Functions class=dd-item><a href=/farmer/api-overview/resources/functions/>Functions</a></li><li data-nav-id=/farmer/api-overview/resources/iot-hub/ title="IOT Hub" class=dd-item><a href=/farmer/api-overview/resources/iot-hub/>IOT Hub</a></li><li data-nav-id=/farmer/api-overview/resources/keyvault/ title="Key Vault" class=dd-item><a href=/farmer/api-overview/resources/keyvault/>Key Vault</a></li><li data-nav-id=/farmer/api-overview/resources/loganalytics/ title="Log Analytics" class=dd-item><a href=/farmer/api-overview/resources/loganalytics/>Log Analytics</a></li><li data-nav-id=/farmer/api-overview/resources/managed-identity/ title="Managed Identity" class=dd-item><a href=/farmer/api-overview/resources/managed-identity/>Managed Identity</a></li><li data-nav-id=/farmer/api-overview/resources/maps/ title=Maps class=dd-item><a href=/farmer/api-overview/resources/maps/>Maps</a></li><li data-nav-id=/farmer/api-overview/resources/nsg/ title="Network Security Group" class=dd-item><a href=/farmer/api-overview/resources/nsg/>Network Security Group</a></li><li data-nav-id=/farmer/api-overview/resources/postgresql/ title=PostgreSQL class=dd-item><a href=/farmer/api-overview/resources/postgresql/>PostgreSQL</a></li><li data-nav-id=/farmer/api-overview/resources/redis/ title="Redis Cache" class=dd-item><a href=/farmer/api-overview/resources/redis/>Redis Cache</a></li><li data-nav-id=/farmer/api-overview/resources/signalr/ title=SignalR class=dd-item><a href=/farmer/api-overview/resources/signalr/>SignalR</a></li><li data-nav-id=/farmer/api-overview/resources/search/ title=Search class=dd-item><a href=/farmer/api-overview/resources/search/>Search</a></li><li data-nav-id=/farmer/api-overview/resources/service-bus/ title="Service Bus" class=dd-item><a href=/farmer/api-overview/resources/service-bus/>Service Bus</a></li><li data-nav-id=/farmer/api-overview/resources/sql/ title="SQL Azure" class=dd-item><a href=/farmer/api-overview/resources/sql/>SQL Azure</a></li><li data-nav-id=/farmer/api-overview/resources/static-web-app/ title="Static Web Apps" class=dd-item><a href=/farmer/api-overview/resources/static-web-app/>Static Web Apps</a></li><li data-nav-id=/farmer/api-overview/resources/storage-account/ title="Storage Account" class=dd-item><a href=/farmer/api-overview/resources/storage-account/>Storage Account</a></li><li data-nav-id=/farmer/api-overview/resources/traffic-manager/ title="Traffic Manager" class=dd-item><a href=/farmer/api-overview/resources/traffic-manager/>Traffic Manager</a></li><li data-nav-id=/farmer/api-overview/resources/azure-firewall/ title="Azure Firewall" class=dd-item><a href=/farmer/api-overview/resources/azure-firewall/>Azure Firewall</a></li><li data-nav-id=/farmer/api-overview/resources/virtual-hub/ title="Virtual Hub" class=dd-item><a href=/farmer/api-overview/resources/virtual-hub/>Virtual Hub</a></li><li data-nav-id=/farmer/api-overview/resources/vnet/ title="Virtual Network" class=dd-item><a href=/farmer/api-overview/resources/vnet/>Virtual Network</a></li><li data-nav-id=/farmer/api-overview/resources/load-balancer/ title="Load Balancer" class=dd-item><a href=/farmer/api-overview/resources/load-balancer/>Load Balancer</a></li><li data-nav-id=/farmer/api-overview/resources/virtual-wan/ title="Virtual WAN" class=dd-item><a href=/farmer/api-overview/resources/virtual-wan/>Virtual WAN</a></li><li data-nav-id=/farmer/api-overview/resources/vnet-gateway/ title="Virtual Network Gateway" class=dd-item><a href=/farmer/api-overview/resources/vnet-gateway/>Virtual Network Gateway</a></li><li data-nav-id=/farmer/api-overview/resources/virtual-machine/ title="Virtual Machine" class=dd-item><a href=/farmer/api-overview/resources/virtual-machine/>Virtual Machine</a></li><li data-nav-id=/farmer/api-overview/resources/web-app/ title="Web App" class=dd-item><a href=/farmer/api-overview/resources/web-app/>Web App</a></li></ul></li></ul></li><li data-nav-id=/farmer/arm-vs-farmer/ title="Farmer and ARM" class=dd-item><a href=/farmer/arm-vs-farmer/>Farmer and ARM</a></li><li data-nav-id=/farmer/deployment-guidance/ title="Deployment Guidance" class=dd-item><a href=/farmer/deployment-guidance/>Deployment Guidance</a></li><li data-nav-id=/farmer/support/ title="Commercial Support" class=dd-item><a href=/farmer/support/>Commercial Support</a></li><li data-nav-id=/farmer/testimonials/ title=Testimonials class=dd-item><a href=/farmer/testimonials/>Testimonials</a></li><li data-nav-id=/farmer/links/ title=Links class=dd-item><a href=/farmer/links/>Links</a></li><li data-nav-id=/farmer/contributing/ title=Contributing class=dd-item><a href=/farmer/contributing/>Contributing</a><ul><li data-nav-id=/farmer/contributing/arm-basics/ title="ARM Basics" class=dd-item><a href=/farmer/contributing/arm-basics/>ARM Basics</a></li><li data-nav-id=/farmer/contributing/outputs-and-expressions/ title="Outputs and ARM Expressions" class=dd-item><a href=/farmer/contributing/outputs-and-expressions/>Outputs and ARM Expressions</a></li><li data-nav-id=/farmer/contributing/create-pull-requests/ title="Creating Pull Requests" class=dd-item><a href=/farmer/contributing/create-pull-requests/>Creating Pull Requests</a></li><li data-nav-id=/farmer/contributing/adding-resources/ title="Supporting a new ARM Resource" class=dd-item><a href=/farmer/contributing/adding-resources/>Supporting a new ARM Resource</a><ul><li data-nav-id=/farmer/contributing/adding-resources/1-the-farmer-pipline/ title="1. The Farmer Pipeline" class=dd-item><a href=/farmer/contributing/adding-resources/1-the-farmer-pipline/>1. The Farmer Pipeline</a></li><li data-nav-id=/farmer/contributing/adding-resources/2-iarm-resource/ title="2. The IArmResource" class=dd-item><a href=/farmer/contributing/adding-resources/2-iarm-resource/>2. The IArmResource</a></li><li data-nav-id=/farmer/contributing/adding-resources/3-ibuilder/ title="3. The IBuilder interface" class=dd-item><a href=/farmer/contributing/adding-resources/3-ibuilder/>3. The IBuilder interface</a></li><li data-nav-id=/farmer/contributing/adding-resources/4-creating-builder-syntax/ title="4. Providing Builder syntax" class=dd-item><a href=/farmer/contributing/adding-resources/4-creating-builder-syntax/>4. Providing Builder syntax</a></li><li data-nav-id=/farmer/contributing/adding-resources/5-unit-testing/ title="5. Unit Testing" class=dd-item><a href=/farmer/contributing/adding-resources/5-unit-testing/>5. Unit Testing</a></li></ul></li></ul></li><li data-nav-id=/farmer/faq/ title=FAQs class=dd-item><a href=/farmer/faq/>FAQs</a></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://github.com/compositionalit/farmer><i class="fab fa-fw fa-github"></i>GitHub repo</a></li><li><a class=padding href=https://www.nuget.org/packages/Farmer/><i class="fab fa-fw fa-microsoft"></i>Nuget</a></li><li><a class=padding href=https://compositional-it.com><img src=/farmer/images/cit.png></img> Compositional IT</a></li></ul></section><section id=footer></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/CompositionalIT/farmer/tree/master/docs/content/tutorials/minecraft-server-aci.md target=blank><i class="fas fa-code-branch"></i><span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span><span class=links><a href=/farmer/>Farmer</a> > <a href=/farmer/tutorials/>Tutorials</a> > Create your own Minecraft Server</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><ul><li></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Create your own Minecraft Server</h1><h4 id=introduction>Introduction</h4><p>In this tutorial, you&rsquo;ll use dotnet framework features and F# language techniques when building a template to create a fully functional <a href=https://www.minecraft.net>Minecraft Server</a> running on an Azure Container Instance with its world data stored in an Azure Storage Account. Because Farmer is a domain specific language embedded within F#, you are able to utilize the rich dotnet ecosystem and a static type system to &ldquo;craft&rdquo; an advanced deployment.</p><ol><li>Programmatically build our Minecraft configuration files.</li><li>Create a storage account for the world data.</li><li>Define a deployment script that will download the Minecraft Server .jar file and upload it to the storage account, along with the configuration files.</li><li>Create a container group for running the service;.</li></ol><h4 id=a-few-dependencies>A few dependencies</h4><p>We will need a few dependencies here, so first let&rsquo;s reference the packages and open the namespaces:</p><ul><li>Farmer - for building that Azure resources and deployment template.</li><li>MinecraftConfig - for building the server configuration files.</li><li>FSharp.Data - for scraping the server download page for the current version of the server .jar file.</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#f92672>#</span>r <span style=color:#e6db74>&#34;nuget: Farmer&#34;</span>
<span style=color:#f92672>#</span>r <span style=color:#e6db74>&#34;nuget: MinecraftConfig&#34;</span>
<span style=color:#f92672>#</span>r <span style=color:#e6db74>&#34;nuget: FSharp.Data&#34;</span>

<span style=color:#66d9ef>open</span> System
<span style=color:#66d9ef>open</span> Farmer
<span style=color:#66d9ef>open</span> Farmer.Builders
<span style=color:#66d9ef>open</span> FSharp.Data
<span style=color:#66d9ef>open</span> MinecraftConfig
</code></pre></div><h4 id=building-the-minecraft-server-configuration-files>Building the Minecraft server configuration files</h4><p>Deploying infrastructure often also means building configuration files, and Minecraft is no different. There are four critical files for a server:</p><ul><li>ops.json - this includes the list of operators that can manage the server.</li><li>whitelist.json - this includes a list of gamers who are allowed to use the server.</li><li>eula.txt - this indicates that you&rsquo;ve accepted the <a href=https://www.minecraft.net/en-us/eula/>End User License Agreement</a> for running a Minecraft Server, and you should read this since downloading and using the game implies you agree with it.</li><li>server.properties - the server is a Java application, and this is the configuration for the application itself.</li></ul><p>First we build a list of users that we will allow on our server. We&rsquo;ll use this list to build both the ops.json (operators) and whitelist.json (allowed gamers), so we will indicate which ones are operators.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#66d9ef>let</span> operator <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
<span style=color:#e6db74>/// Our list of minecraft users - their username, uuid, and whether or not they are an operator.
</span><span style=color:#e6db74></span><span style=color:#66d9ef>let</span> minecrafters <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
        <span style=color:#e6db74>&#34;McUser1&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;a6a66bfb-6ff7-46e3-981e-518e6a3f0e71&#34;</span><span style=color:#f92672>,</span> operator
        <span style=color:#e6db74>&#34;McUser2&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;d3f2e456-d6a4-47ac-a7f0-41a4dc8ed156&#34;</span><span style=color:#f92672>,</span> <span style=color:#f92672>not</span> operator
        <span style=color:#e6db74>&#34;McUser3&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;ceb50330-681a-4d9d-8e84-f76133d0fd28&#34;</span><span style=color:#f92672>,</span> <span style=color:#f92672>not</span> operator
    <span style=color:#f92672>]</span>
</code></pre></div><p>Now we build the whitelist.json and ops.json files - the MinecraftConfig application handles formatting the configuration file, we just need to map from our list of <code>minecrafters</code> to the lists of the records for the whitelist and the operator. <code>whitelist</code> holds the contents of our whitelist.json file, and <code>ops</code> hosts the contents of the ops.json file. We will write use those later.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#e6db74>/// Let&#39;s allow our list of minecrafters on the whitelist.
</span><span style=color:#e6db74></span><span style=color:#66d9ef>let</span> whitelist <span style=color:#f92672>=</span>
    minecrafters
    <span style=color:#f92672>|&gt;</span> List.map <span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> <span style=color:#f92672>(</span>name<span style=color:#f92672>,</span> uuid<span style=color:#f92672>,</span> <span style=color:#f92672>_)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span> Name<span style=color:#f92672>=</span>name<span style=color:#f92672>;</span> Uuid<span style=color:#f92672>=</span>uuid <span style=color:#f92672>})</span>
    <span style=color:#f92672>|&gt;</span> Whitelist.format

<span style=color:#e6db74>/// Filter the minecrafters that aren&#39;t operators.
</span><span style=color:#e6db74></span><span style=color:#66d9ef>let</span> ops <span style=color:#f92672>=</span>
    minecrafters
    <span style=color:#f92672>|&gt;</span> List.filter <span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> <span style=color:#f92672>(_,</span> <span style=color:#f92672>_,</span> op<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> op<span style=color:#f92672>)</span> <span style=color:#75715e>// Filter anyone that isn&#39;t an operator
</span><span style=color:#75715e></span>    <span style=color:#f92672>|&gt;</span> List.map <span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> <span style=color:#f92672>(</span>name<span style=color:#f92672>,</span> uuid<span style=color:#f92672>,</span> <span style=color:#f92672>_)</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span> Name<span style=color:#f92672>=</span>name<span style=color:#f92672>;</span> Level<span style=color:#f92672>=</span>OperatorLevel.Level4<span style=color:#f92672>;</span> Uuid<span style=color:#f92672>=</span>uuid <span style=color:#f92672>})</span>
    <span style=color:#f92672>|&gt;</span> Ops.format
</code></pre></div><p>And we can generate an accepted EULA, storing this content in <code>eula</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#e6db74>/// And accept the EULA.
</span><span style=color:#e6db74></span><span style=color:#66d9ef>let</span> eula <span style=color:#f92672>=</span> Eula.format <span style=color:#66d9ef>true</span>
</code></pre></div><p>Now we need a few properties that are used both for the server.properties and for the resulting infrastructure. The <code>worldName</code> tells Minecraft where to store the world data. Since this will be mounted to an Azure Storage File share, we create a binding for it to make sure the name we use in the server.properties file matches what we use in the storage account.</p><p>Same for the <code>serverPort</code>, which is both used in the server.properties file and must be exposed publicly on the Azure Container Group.</p><p>The name of the storage account is used in three places: the storage account itself, in the deployment script that will upload files to the storage account, and in the container group that will mount a volume from it. The <code>storageAccountName</code> can be referenced in all three uses.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#e6db74>/// Add bindings for fields that are referenced in a few places
</span><span style=color:#e6db74>/// Name of the share for the world.
</span><span style=color:#e6db74></span><span style=color:#66d9ef>let</span> worldName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;world1&#34;</span>
<span style=color:#e6db74>/// Port for this world
</span><span style=color:#e6db74></span><span style=color:#66d9ef>let</span> serverPort <span style=color:#f92672>=</span> 25565
<span style=color:#e6db74>/// Storage account name
</span><span style=color:#e6db74></span><span style=color:#66d9ef>let</span> storageAccountName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;mcworlddata&#34;</span>
</code></pre></div><p>And now we create the server.properties file, storing it in <code>serverProperties</code>. With that, we completed generating all of the configuration files for the server and can move on to defining and deploying the infrastructure.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#e6db74>/// Write the customized server properties.
</span><span style=color:#e6db74></span><span style=color:#66d9ef>let</span> serverProperties <span style=color:#f92672>=</span>
    <span style=color:#f92672>[</span>
        ServerPort serverPort
        RconPort <span style=color:#f92672>(</span>serverPort <span style=color:#f92672>+</span> 10<span style=color:#f92672>)</span>
        EnforceWhitelist <span style=color:#66d9ef>true</span>
        WhiteList <span style=color:#66d9ef>true</span>
        Motd <span style=color:#e6db74>&#34;Azure Minecraft Server&#34;</span>
        LevelName worldName
        Gamemode <span style=color:#e6db74>&#34;survival&#34;</span>
    <span style=color:#f92672>]</span>
    <span style=color:#f92672>|&gt;</span> ServerProperties.format
</code></pre></div><h4 id=creating-the-storage-account>Creating the Storage Account</h4><p>A Minecraft server stores some data for the world that is generated and people play in. That data, along with the configuration files, is stored in a directory that must be accessible to the server. Azure Container Groups are able to attach an Azure Storage Account File share as a volume, so we will create a storage account with a file share.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#e6db74>/// A storage account, with a file share for the server config and world data.
</span><span style=color:#e6db74></span><span style=color:#66d9ef>let</span> serverStorage <span style=color:#f92672>=</span> storageAccount <span style=color:#f92672>{</span>
    name storageAccountName
    sku Storage.Sku.Standard_LRS
    add_file_share_with_quota worldName 5<span style=color:#f92672>&lt;</span>Gb<span style=color:#f92672>&gt;</span>
<span style=color:#f92672>}</span>
</code></pre></div><h4 id=defining-the-deployment-script>Defining the Deployment Script</h4><p>There are some deployment orchestration tasks that cannot be fully represented by Azure resources, but we need ARM to carry them out for us. We can use <code>deploymentScripts</code> as an Azure resource to represent script execution. This allows us to specify orchestration properties, such as that ARM should execute this deployment script <em>after</em> the storage account is deployed.</p><p>The script itself runs in a temporary container that has the Azure CLI ready and authenticated with a user that has the &ldquo;Contributor&rdquo; role over everything in this deployment. This is helpful because it means our script runs as a user that can access the storage account to upload content.</p><p>We need this deployment script to do three things:</p><ol><li>Copy the configuration files to the storage account.</li><li>Download the current server.jar to the script container&rsquo;s temporary storage.</li><li>Upload the server.jar to the storage account.</li></ol><h5 id=embedding-configuration-files>Embedding Configuration Files</h5><p>First we will tackle the configuration files. We are going use F# to generate the CLI script, so we can actually embed these in the deployment script itself. To avoid any trouble with escaping characters for our script, we will encode all of the configuration files as base64 strings when we build the script and then the script will decode the base64 data and write files out to the container file system where the Azure CLI can upload them.</p><ol><li>Convert each configuration file to base64.</li><li>Embed in shell script run by deployment.</li><li>When the deployment script runs, it will decode and save as files.</li><li>And then it will use <code>az storage file upload</code> to transfer them to the storage account.</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#e6db74>/// A deployment script to create the config in the file share.
</span><span style=color:#e6db74></span><span style=color:#66d9ef>let</span> deployConfig <span style=color:#f92672>=</span>
    <span style=color:#75715e>// Helper function to base64 encode the files for embedding them in the
</span><span style=color:#75715e></span>    <span style=color:#75715e>// deployment script.
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> b64 <span style=color:#f92672>(</span>s<span style=color:#f92672>:</span><span style=color:#66d9ef>string</span><span style=color:#f92672>)</span> <span style=color:#f92672>=</span>
        s <span style=color:#f92672>|&gt;</span> System.Text.Encoding.UTF8.GetBytes <span style=color:#f92672>|&gt;</span> Convert.ToBase64String

    <span style=color:#75715e>// Build a script that embeds the content of these files, writes to the
</span><span style=color:#75715e></span>    <span style=color:#75715e>// deploymentScript instance and then copies
</span><span style=color:#75715e></span>    <span style=color:#75715e>// to the storageAccount file share. We will include the contents of these
</span><span style=color:#75715e></span>    <span style=color:#75715e>// files as base64 encoded strings so there is no need to worry about
</span><span style=color:#75715e></span>    <span style=color:#75715e>// special characters in the embedded script.
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> uploadConfig <span style=color:#f92672>=</span>
        <span style=color:#f92672>[</span>
            whitelist<span style=color:#f92672>,</span> Whitelist.Filename
            ops<span style=color:#f92672>,</span> Ops.Filename
            eula<span style=color:#f92672>,</span> Eula.Filename
            serverProperties<span style=color:#f92672>,</span> ServerProperties.Filename
        <span style=color:#f92672>]</span>
        <span style=color:#f92672>|&gt;</span> List.map <span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> <span style=color:#f92672>(</span>content<span style=color:#f92672>,</span> filename<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span>
                     <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;echo {b64 content} | base64 -d &gt; {filename} &amp;&amp; az storage file upload --account-name {storageAccountName} --share-name {worldName} --source {filename}&#34;</span><span style=color:#f92672>)</span>

</code></pre></div><p>That seemed a bit complicated, but using the best of both F# and the Azure CLI, the actual code to do this is minimal. The <code>b64</code> function converts any string you give it to bytes and then base64 encodes those bytes into a string we can embed in the script.</p><p>Next we have a list that contains the contents of each configuration file paired with the filename we need to write. We map each of those items to an interpolated string, which is where F# can execute little bits of code when building the string. Within the interpolated string, we call the <code>b64</code> function to encode the contents of each file, which is what <code>$"echo {b64 content}"</code> does. When the script executes, it will pass that string into <code>base64 -d</code> which decides the base64 back into bytes that are written to a file. After each file is written, it&rsquo;s uploaded with <code>az storage file upload</code> which again uses interpolated string values to get the <code>storageAccountName</code>, <code>worldName</code>, and <code>filename</code> values.</p><h5 id=deploying-the-server-software>Deploying the Server Software</h5><p>Having embedded the configuration files, now we need to add a line to the script to download the Minecraft server.jar and upload it as well. Whenever a new Minecraft Server is released, they update this page with a link that is named for the server version.</p><p>Without F#, we would probably stop here and just use the link for whatever version is out today. But F# has nice toys for reading and exploring data, like FSharp.Data which can parse HTML files, so we&rsquo;re only a few lines away from scraping the download page for the link to the current version.</p><p>When this F# code is executed to build the ARM template, it will load the Download page, find the link starting with <code>minecraft_server</code>, and copy the URL from the <code>href</code> on that link. We will embed that URL into our deployment script as a parameter to a <code>curl</code> call which will download the file before calling <code>az storage file upload</code> to copy the file to the storage account.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp>    <span style=color:#e6db74>/// The script will also need to download the server.jar and upload it.
</span><span style=color:#e6db74></span>    <span style=color:#66d9ef>let</span> uploadServerJar <span style=color:#f92672>=</span>
        <span style=color:#66d9ef>let</span> results <span style=color:#f92672>=</span> HtmlDocument.Load <span style=color:#e6db74>&#34;https://www.minecraft.net/en-us/download/server&#34;</span>
        <span style=color:#75715e>// Scrape for anchor tags from this download page.
</span><span style=color:#75715e></span>        results<span style=color:#f92672>.</span>Descendants <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;a&#34;</span><span style=color:#f92672>]</span>
        <span style=color:#75715e>// where the inner text contains &#34;minecraft_server&#34; since that&#39;s what is
</span><span style=color:#75715e></span>        <span style=color:#75715e>// displayed on that link
</span><span style=color:#75715e></span>        <span style=color:#f92672>|&gt;</span> Seq.filter <span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> <span style=color:#f92672>(</span>x<span style=color:#f92672>:</span>HtmlNode<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> x<span style=color:#f92672>.</span>InnerText()<span style=color:#f92672>.</span>StartsWith <span style=color:#e6db74>&#34;minecraft_server&#34;</span><span style=color:#f92672>)</span>
        <span style=color:#75715e>// And choose the &#34;href&#34; attribute if present
</span><span style=color:#75715e></span>        <span style=color:#f92672>|&gt;</span> Seq.choose<span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> <span style=color:#f92672>(</span>x<span style=color:#f92672>:</span>HtmlNode<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> x<span style=color:#f92672>.</span>TryGetAttribute<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;href&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>|&gt;</span> Option.map<span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> <span style=color:#f92672>(</span>a<span style=color:#f92672>:</span>HtmlAttribute<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> a<span style=color:#f92672>.</span>Value()<span style=color:#f92672>))</span>
        <span style=color:#f92672>|&gt;</span> Seq.head <span style=color:#75715e>// If it wasn&#39;t found, we&#39;ll get an error here.
</span><span style=color:#75715e></span>        <span style=color:#f92672>|&gt;</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> url <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;curl -O {url} &amp;&amp; az storage file upload --account-name {storageAccountName} --share-name {worldName} --source server.jar&#34;</span><span style=color:#f92672>)</span>
</code></pre></div><p>Now we have two lists:</p><ul><li><code>uploadConfig</code> is a list of the four lines of <code>bash</code> that will decode and then upload the configuration files to the storage account.</li><li><code>uploadServerJar</code> is a line of <code>bash</code> to download the server software and upload it to the storage account.</li></ul><p>We concat those lines together with a semicolon <code>;</code> to break up our commands, and we have a full script we can run. The <code>deploymentScript</code> resource itself is fairly simple, and we use <code>depends_on serverStorage</code> to make sure this only runs <em>after</em> our storage account is deployed.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp>    <span style=color:#66d9ef>let</span> scriptSource <span style=color:#f92672>=</span>
        uploadServerJar <span style=color:#f92672>::</span> uploadConfig
        <span style=color:#f92672>|&gt;</span> List.rev <span style=color:#75715e>// do the server upload last so it won&#39;t start until the configs are in place.
</span><span style=color:#75715e></span>        <span style=color:#f92672>|&gt;</span> String.concat <span style=color:#e6db74>&#34;; &#34;</span>

    deploymentScript <span style=color:#f92672>{</span>
        name <span style=color:#e6db74>&#34;deployMinecraftConfig&#34;</span>
        <span style=color:#75715e>// Depend on the storage account so this won&#39;t run until it&#39;s there.
</span><span style=color:#75715e></span>        depends_on serverStorage
        script_content scriptSource
        force_update
    <span style=color:#f92672>}</span>
</code></pre></div><h4 id=creating-the-container-instance>Creating the Container Instance</h4><p>The container instance runs a Java Runtime Environmennt, giving it enough CPU and memory for a small server with a few players. It has a volume mounted to the Azure Storage Account File share where the configuration files and server.jar are uploaded.</p><p>The <code>containerGroup</code> has a dependency on the <code>storageAccount</code> so it won&rsquo;t be deployed until the storageAccount is deployed. There is a bit of a race condition since the container group could be deployed and start before the <code>deploymentScript</code> uploads the server.jar and configuration files. To prevent this issue the container runs a <code>while</code> loop in <code>bash</code> until the server starts successfully.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#66d9ef>let</span> serverContainer <span style=color:#f92672>=</span> containerGroup <span style=color:#f92672>{</span>
    name <span style=color:#e6db74>&#34;minecraft-server&#34;</span>
    public_dns <span style=color:#e6db74>&#34;azmcworld1&#34;</span> <span style=color:#f92672>[</span> TCP<span style=color:#f92672>,</span> <span style=color:#66d9ef>uint16</span> serverPort <span style=color:#f92672>]</span>
    add_instances <span style=color:#f92672>[</span>
        containerInstance <span style=color:#f92672>{</span>
            name <span style=color:#e6db74>&#34;minecraftserver&#34;</span>
            image <span style=color:#e6db74>&#34;mcr.microsoft.com/java/jre-headless:8-zulu-alpine&#34;</span>
            <span style=color:#75715e>// The command line needs to change to the directory for the file share
</span><span style=color:#75715e></span>            <span style=color:#75715e>// and then start the server.
</span><span style=color:#75715e></span>            <span style=color:#75715e>// It needs a little more memory than the defaults, -Xmx3G gives it 3 GiB
</span><span style=color:#75715e></span>            <span style=color:#75715e>// of memory.
</span><span style=color:#75715e></span>            command_line <span style=color:#f92672>[</span>
                <span style=color:#e6db74>&#34;/bin/sh&#34;</span>
                <span style=color:#e6db74>&#34;-c&#34;</span>
                <span style=color:#75715e>// We will need to do a retry loop since we can&#39;t have a depends_on
</span><span style=color:#75715e></span>                <span style=color:#75715e>// for the deploymentScript to finish.
</span><span style=color:#75715e></span>                <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;cd /data/{worldName}; while true; do java -Djava.net.preferIPv4Stack=true -Xms1G -Xmx3G -jar server.jar nogui &amp;&amp; break; sleep 30; done&#34;</span>
            <span style=color:#f92672>]</span>
            <span style=color:#75715e>// If we chose a custom port in the settings, it should go here.
</span><span style=color:#75715e></span>            add_public_ports <span style=color:#f92672>[</span> <span style=color:#66d9ef>uint16</span> serverPort <span style=color:#f92672>]</span>
            <span style=color:#75715e>// It needs a couple cores or the world may lag with a few players
</span><span style=color:#75715e></span>            cpu_cores 2
            <span style=color:#75715e>// Give it enough memory for the JVM
</span><span style=color:#75715e></span>            memory 3<span style=color:#f92672>.</span>5<span style=color:#f92672>&lt;</span>Gb<span style=color:#f92672>&gt;</span>
            <span style=color:#75715e>// Mount the path to the Azure Storage File share in the container
</span><span style=color:#75715e></span>            add_volume_mount worldName <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;/data/{worldName}&#34;</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>]</span>
    <span style=color:#75715e>// Add the file share for the world data and server configuration.
</span><span style=color:#75715e></span>    add_volumes <span style=color:#f92672>[</span>
        volume_mount<span style=color:#f92672>.</span>azureFile worldName worldName serverStorage<span style=color:#f92672>.</span>Name<span style=color:#f92672>.</span>ResourceName<span style=color:#f92672>.</span>Value
    <span style=color:#f92672>]</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Here we will build the template. The <code>deployConfig</code> deployment script is especially interesting as it contains the embedded configuration files and the <code>curl</code> command with the link to the current <code>server.jar</code> from scraping the download page.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#e6db74>/// Build the deployment with storage, deployment script, and container group.
</span><span style=color:#e6db74></span><span style=color:#66d9ef>let</span> deployment <span style=color:#f92672>=</span> arm <span style=color:#f92672>{</span>
    location Location.EastUS
    add_resources <span style=color:#f92672>[</span>
        serverStorage
        deployConfig
        serverContainer
    <span style=color:#f92672>]</span>
<span style=color:#f92672>}</span>
deployment <span style=color:#f92672>|&gt;</span> Writer.quickWrite <span style=color:#e6db74>&#34;minecraft-server&#34;</span>
</code></pre></div><p>After running this deployment, view the container group in the Azure Portal or with <code>az container logs</code> to watch the server start up and generate a world. Once the world is generated, it&rsquo;s ready to connect from your Minecraft Java Edition client by entering the DNS name for the container group!</p><p>If you need to change the configuration you could connect to the terminal of the container instance. But in the spirit of mature configuration management and immutable infrastructure, you should rebuild the config, stop the container group, and redeploy. The existing state - the minecraft world data - is left intact in the storage account and the configuration is replaced with your updates. Once the update is deployed, you can restart the container group.</p><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=/farmer/tutorials/keyvault-certs/ title="Declarative Steps in an ARM Deployment"><i class="fa fa-chevron-left"></i></a><a class="nav nav-next" href=/farmer/tutorials/aci-fsx/ title="F# Script in a Container Group" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/farmer/js/clipboard.min.js?1633543444></script><script src=/farmer/js/perfect-scrollbar.min.js?1633543444></script><script src=/farmer/js/perfect-scrollbar.jquery.min.js?1633543444></script><script src=/farmer/js/jquery.sticky.js?1633543444></script><script src=/farmer/js/featherlight.min.js?1633543444></script><script src=/farmer/js/highlight.pack.js?1633543444></script><script>hljs.initHighlightingOnLoad();</script><script src=/farmer/js/modernizr.custom-3.6.0.js?1633543444></script><script src=/farmer/js/learn.js?1633543444></script><script src=/farmer/js/hugo-learn.js?1633543444></script><link href=/farmer/mermaid/mermaid.css?1633543444 rel=stylesheet><script src=/farmer/mermaid/mermaid.js?1633543444></script><script>mermaid.initialize({startOnLoad:true});</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-72817248-3','auto');ga('send','pageview');</script></body></html>