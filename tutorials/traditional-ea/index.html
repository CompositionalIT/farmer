<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.68.3"><meta name=description content="Farmer - Making repeatable Azure deployments easy!"><link rel=icon href=/farmer/images/farmer-favicon.png type=image/png><title>Traditional Enterprise Application to the Azure Cloud, managed via Farmer :: Farmer</title><link href=/farmer/css/nucleus.css?1724811008 rel=stylesheet><link href=/farmer/css/fontawesome-all.min.css?1724811008 rel=stylesheet><link href=/farmer/css/hybrid.css?1724811008 rel=stylesheet><link href=/farmer/css/featherlight.min.css?1724811008 rel=stylesheet><link href=/farmer/css/perfect-scrollbar.min.css?1724811008 rel=stylesheet><link href=/farmer/css/auto-complete.css?1724811008 rel=stylesheet><link href=/farmer/css/atom-one-dark-reasonable.css?1724811008 rel=stylesheet><link href=/farmer/css/theme.css?1724811008 rel=stylesheet><link href=/farmer/css/hugo-theme.css?1724811008 rel=stylesheet><link href=/farmer/css/theme-green.css?1724811008 rel=stylesheet><script src=/farmer/js/jquery-3.3.1.min.js?1724811008></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/farmer/tutorials/traditional-ea/><nav id=sidebar><div id=header-wrapper><div id=header><img src=/farmer/images/logo.png></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label><input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/farmer/js/lunr.min.js?1724811008></script><script type=text/javascript src=/farmer/js/auto-complete.js?1724811008></script><script type=text/javascript>var baseurl="https:\/\/compositionalit.github.io\/farmer\/";</script><script type=text/javascript src=/farmer/js/search.js?1724811008></script></div><div class=highlightable><ul class=topics><li data-nav-id=/farmer/about/ title=About class=dd-item><a href=/farmer/about/>About</a></li><li data-nav-id=/farmer/quickstarts/ title=Quickstarts class=dd-item><a href=/farmer/quickstarts/>Quickstarts</a><ul><li data-nav-id=/farmer/quickstarts/quickstart-1/ title="Your first Farmer template" class=dd-item><a href=/farmer/quickstarts/quickstart-1/>Your first Farmer template</a></li><li data-nav-id=/farmer/quickstarts/quickstart-2/ title="Working with multiple resources" class=dd-item><a href=/farmer/quickstarts/quickstart-2/>Working with multiple resources</a></li><li data-nav-id=/farmer/quickstarts/quickstart-3/ title="Deploying to Azure" class=dd-item><a href=/farmer/quickstarts/quickstart-3/>Deploying to Azure</a></li><li data-nav-id=/farmer/quickstarts/template/ title="The Farmer .NET Template" class=dd-item><a href=/farmer/quickstarts/template/>The Farmer .NET Template</a></li></ul></li><li data-nav-id=/farmer/tutorials/ title=Tutorials class="dd-item
parent"><a href=/farmer/tutorials/>Tutorials</a><ul><li data-nav-id=/farmer/tutorials/traditional-ea/ title="Traditional Enterprise Application to the Azure Cloud, managed via Farmer" class="dd-item active"><a href=/farmer/tutorials/traditional-ea/>Traditional Enterprise Application to the Azure Cloud, managed via Farmer</a></li><li data-nav-id=/farmer/tutorials/webapp-deploy/ title="Deploy an ASP.NET app" class=dd-item><a href=/farmer/tutorials/webapp-deploy/>Deploy an ASP.NET app</a></li><li data-nav-id=/farmer/tutorials/custom-output/ title="Custom Output with ARM Expressions" class=dd-item><a href=/farmer/tutorials/custom-output/>Custom Output with ARM Expressions</a></li><li data-nav-id=/farmer/tutorials/keyvault-certs/ title="Declarative Steps in an ARM Deployment" class=dd-item><a href=/farmer/tutorials/keyvault-certs/>Declarative Steps in an ARM Deployment</a></li><li data-nav-id=/farmer/tutorials/minecraft-server-aci/ title="Create your own Minecraft Server" class=dd-item><a href=/farmer/tutorials/minecraft-server-aci/>Create your own Minecraft Server</a></li><li data-nav-id=/farmer/tutorials/aci-fsx/ title="F# Script in a Container Group" class=dd-item><a href=/farmer/tutorials/aci-fsx/>F# Script in a Container Group</a></li><li data-nav-id=/farmer/tutorials/cosmos-backed-webapp/ title="Cosmos-backed Web App" class=dd-item><a href=/farmer/tutorials/cosmos-backed-webapp/>Cosmos-backed Web App</a></li><li data-nav-id=/farmer/tutorials/multiple-web-apps/ title="Multiple web apps" class=dd-item><a href=/farmer/tutorials/multiple-web-apps/>Multiple web apps</a></li><li data-nav-id=/farmer/tutorials/serverless-etl/ title="Serverless ETL" class=dd-item><a href=/farmer/tutorials/serverless-etl/>Serverless ETL</a></li><li data-nav-id=/farmer/tutorials/web-storage-keyvault/ title="Web App Secrets with KeyVault" class=dd-item><a href=/farmer/tutorials/web-storage-keyvault/>Web App Secrets with KeyVault</a></li></ul></li><li data-nav-id=/farmer/api-overview/ title="API Overview" class=dd-item><a href=/farmer/api-overview/>API Overview</a><ul><li data-nav-id=/farmer/api-overview/template-generation/ title="Generating templates" class=dd-item><a href=/farmer/api-overview/template-generation/>Generating templates</a></li><li data-nav-id=/farmer/api-overview/expressions/ title="ARM Expressions" class=dd-item><a href=/farmer/api-overview/expressions/>ARM Expressions</a></li><li data-nav-id=/farmer/api-overview/parameters/ title="Parameters and Variables" class=dd-item><a href=/farmer/api-overview/parameters/>Parameters and Variables</a></li><li data-nav-id=/farmer/api-overview/basic-types/ title="Basic Types" class=dd-item><a href=/farmer/api-overview/basic-types/>Basic Types</a></li><li data-nav-id=/farmer/api-overview/dependencies/ title=Dependencies class=dd-item><a href=/farmer/api-overview/dependencies/>Dependencies</a></li><li data-nav-id=/farmer/api-overview/outputs/ title=Outputs class=dd-item><a href=/farmer/api-overview/outputs/>Outputs</a></li><li data-nav-id=/farmer/api-overview/resources/ title=Resources class=dd-item><a href=/farmer/api-overview/resources/>Resources</a><ul><li data-nav-id=/farmer/api-overview/resources/b2c-tenant/ title="B2C Tenant" class=dd-item><a href=/farmer/api-overview/resources/b2c-tenant/>B2C Tenant</a></li><li data-nav-id=/farmer/api-overview/resources/action-group/ title="App Insights - Action Group" class=dd-item><a href=/farmer/api-overview/resources/action-group/>App Insights - Action Group</a></li><li data-nav-id=/farmer/api-overview/resources/application-gateway/ title="Application Gateway" class=dd-item><a href=/farmer/api-overview/resources/application-gateway/>Application Gateway</a></li><li data-nav-id=/farmer/api-overview/resources/alert/ title="App Insights - Alerts" class=dd-item><a href=/farmer/api-overview/resources/alert/>App Insights - Alerts</a></li><li data-nav-id=/farmer/api-overview/resources/availability-tests/ title="App Insights - Availability Tests" class=dd-item><a href=/farmer/api-overview/resources/availability-tests/>App Insights - Availability Tests</a></li><li data-nav-id=/farmer/api-overview/resources/azure-firewall/ title="Azure Firewall" class=dd-item><a href=/farmer/api-overview/resources/azure-firewall/>Azure Firewall</a></li><li data-nav-id=/farmer/api-overview/resources/aks-cluster/ title="AKS Cluster" class=dd-item><a href=/farmer/api-overview/resources/aks-cluster/>AKS Cluster</a></li><li data-nav-id=/farmer/api-overview/resources/app-insights/ title="App Insights" class=dd-item><a href=/farmer/api-overview/resources/app-insights/>App Insights</a></li><li data-nav-id=/farmer/api-overview/resources/bing-search/ title="Bing Search" class=dd-item><a href=/farmer/api-overview/resources/bing-search/>Bing Search</a></li><li data-nav-id=/farmer/api-overview/resources/bastion-host/ title="Bastion Host" class=dd-item><a href=/farmer/api-overview/resources/bastion-host/>Bastion Host</a></li><li data-nav-id=/farmer/api-overview/resources/container-apps/ title="Container Apps" class=dd-item><a href=/farmer/api-overview/resources/container-apps/>Container Apps</a></li><li data-nav-id=/farmer/api-overview/resources/communication-services/ title="Communication Services" class=dd-item><a href=/farmer/api-overview/resources/communication-services/>Communication Services</a></li><li data-nav-id=/farmer/api-overview/resources/container-group/ title="Container Group" class=dd-item><a href=/farmer/api-overview/resources/container-group/>Container Group</a></li><li data-nav-id=/farmer/api-overview/resources/container-registry/ title="Container Registry" class=dd-item><a href=/farmer/api-overview/resources/container-registry/>Container Registry</a></li><li data-nav-id=/farmer/api-overview/resources/cognitive-services/ title="Cognitive Services" class=dd-item><a href=/farmer/api-overview/resources/cognitive-services/>Cognitive Services</a></li><li data-nav-id=/farmer/api-overview/resources/cosmos-db/ title="Cosmos DB" class=dd-item><a href=/farmer/api-overview/resources/cosmos-db/>Cosmos DB</a></li><li data-nav-id=/farmer/api-overview/resources/cdn/ title=CDN class=dd-item><a href=/farmer/api-overview/resources/cdn/>CDN</a></li><li data-nav-id=/farmer/api-overview/resources/dns-resolver/ title="DNS Resolver" class=dd-item><a href=/farmer/api-overview/resources/dns-resolver/>DNS Resolver</a></li><li data-nav-id=/farmer/api-overview/resources/dashboard/ title=Dashboard class=dd-item><a href=/farmer/api-overview/resources/dashboard/>Dashboard</a></li><li data-nav-id=/farmer/api-overview/resources/databricks-workspace/ title="Databricks Workspace" class=dd-item><a href=/farmer/api-overview/resources/databricks-workspace/>Databricks Workspace</a></li><li data-nav-id=/farmer/api-overview/resources/deployment-script/ title="Deployment Script" class=dd-item><a href=/farmer/api-overview/resources/deployment-script/>Deployment Script</a></li><li data-nav-id=/farmer/api-overview/resources/dns/ title="DNS Zone" class=dd-item><a href=/farmer/api-overview/resources/dns/>DNS Zone</a></li><li data-nav-id=/farmer/api-overview/resources/data-lake/ title="Data Lake" class=dd-item><a href=/farmer/api-overview/resources/data-lake/>Data Lake</a></li><li data-nav-id=/farmer/api-overview/resources/diagnosticsetting/ title="Diagnostic Settings" class=dd-item><a href=/farmer/api-overview/resources/diagnosticsetting/>Diagnostic Settings</a></li><li data-nav-id=/farmer/api-overview/resources/dedicated-hosts/ title="Dedicated Hosts" class=dd-item><a href=/farmer/api-overview/resources/dedicated-hosts/>Dedicated Hosts</a></li><li data-nav-id=/farmer/api-overview/resources/route-tables/ title="Route Tables" class=dd-item><a href=/farmer/api-overview/resources/route-tables/>Route Tables</a></li><li data-nav-id=/farmer/api-overview/resources/nat-gateway/ title="NAT Gateway" class=dd-item><a href=/farmer/api-overview/resources/nat-gateway/>NAT Gateway</a></li><li data-nav-id=/farmer/api-overview/resources/event-grid/ title="Event Grid" class=dd-item><a href=/farmer/api-overview/resources/event-grid/>Event Grid</a></li><li data-nav-id=/farmer/api-overview/resources/express-route/ title=ExpressRoute class=dd-item><a href=/farmer/api-overview/resources/express-route/>ExpressRoute</a></li><li data-nav-id=/farmer/api-overview/resources/event-hub/ title="Event Hub" class=dd-item><a href=/farmer/api-overview/resources/event-hub/>Event Hub</a></li><li data-nav-id=/farmer/api-overview/resources/network-interface/ title="Network Interface" class=dd-item><a href=/farmer/api-overview/resources/network-interface/>Network Interface</a></li><li data-nav-id=/farmer/api-overview/resources/route-server/ title="Route Server" class=dd-item><a href=/farmer/api-overview/resources/route-server/>Route Server</a></li><li data-nav-id=/farmer/api-overview/resources/functions/ title=Functions class=dd-item><a href=/farmer/api-overview/resources/functions/>Functions</a></li><li data-nav-id=/farmer/api-overview/resources/iot-hub/ title="IOT Hub" class=dd-item><a href=/farmer/api-overview/resources/iot-hub/>IOT Hub</a></li><li data-nav-id=/farmer/api-overview/resources/gallery/ title=Gallery class=dd-item><a href=/farmer/api-overview/resources/gallery/>Gallery</a></li><li data-nav-id=/farmer/api-overview/resources/image-template/ title="Image Template" class=dd-item><a href=/farmer/api-overview/resources/image-template/>Image Template</a></li><li data-nav-id=/farmer/api-overview/resources/keyvault/ title="Key Vault" class=dd-item><a href=/farmer/api-overview/resources/keyvault/>Key Vault</a></li><li data-nav-id=/farmer/api-overview/resources/private-endpoint/ title="Private Endpoint" class=dd-item><a href=/farmer/api-overview/resources/private-endpoint/>Private Endpoint</a></li><li data-nav-id=/farmer/api-overview/resources/private-link-service/ title="Private Link Service" class=dd-item><a href=/farmer/api-overview/resources/private-link-service/>Private Link Service</a></li><li data-nav-id=/farmer/api-overview/resources/logic-apps/ title="Logic Apps" class=dd-item><a href=/farmer/api-overview/resources/logic-apps/>Logic Apps</a></li><li data-nav-id=/farmer/api-overview/resources/load-balancer/ title="Load Balancer" class=dd-item><a href=/farmer/api-overview/resources/load-balancer/>Load Balancer</a></li><li data-nav-id=/farmer/api-overview/resources/loganalytics/ title="Log Analytics" class=dd-item><a href=/farmer/api-overview/resources/loganalytics/>Log Analytics</a></li><li data-nav-id=/farmer/api-overview/resources/managed-identity/ title="Managed Identity" class=dd-item><a href=/farmer/api-overview/resources/managed-identity/>Managed Identity</a></li><li data-nav-id=/farmer/api-overview/resources/maps/ title=Maps class=dd-item><a href=/farmer/api-overview/resources/maps/>Maps</a></li><li data-nav-id=/farmer/api-overview/resources/nsg/ title="Network Security Group" class=dd-item><a href=/farmer/api-overview/resources/nsg/>Network Security Group</a></li><li data-nav-id=/farmer/api-overview/resources/operations-management/ title="Operations Management" class=dd-item><a href=/farmer/api-overview/resources/operations-management/>Operations Management</a></li><li data-nav-id=/farmer/api-overview/resources/postgresql/ title=PostgreSQL class=dd-item><a href=/farmer/api-overview/resources/postgresql/>PostgreSQL</a></li><li data-nav-id=/farmer/api-overview/resources/redis/ title="Redis Cache" class=dd-item><a href=/farmer/api-overview/resources/redis/>Redis Cache</a></li><li data-nav-id=/farmer/api-overview/resources/resource-group/ title="Resource Group" class=dd-item><a href=/farmer/api-overview/resources/resource-group/>Resource Group</a></li><li data-nav-id=/farmer/api-overview/resources/signalr/ title=SignalR class=dd-item><a href=/farmer/api-overview/resources/signalr/>SignalR</a></li><li data-nav-id=/farmer/api-overview/resources/search/ title=Search class=dd-item><a href=/farmer/api-overview/resources/search/>Search</a></li><li data-nav-id=/farmer/api-overview/resources/service-bus/ title="Service Bus" class=dd-item><a href=/farmer/api-overview/resources/service-bus/>Service Bus</a></li><li data-nav-id=/farmer/api-overview/resources/sql/ title="SQL Azure" class=dd-item><a href=/farmer/api-overview/resources/sql/>SQL Azure</a></li><li data-nav-id=/farmer/api-overview/resources/static-web-app/ title="Static Web Apps" class=dd-item><a href=/farmer/api-overview/resources/static-web-app/>Static Web Apps</a></li><li data-nav-id=/farmer/api-overview/resources/storage-account/ title="Storage Account" class=dd-item><a href=/farmer/api-overview/resources/storage-account/>Storage Account</a></li><li data-nav-id=/farmer/api-overview/resources/traffic-manager/ title="Traffic Manager" class=dd-item><a href=/farmer/api-overview/resources/traffic-manager/>Traffic Manager</a></li><li data-nav-id=/farmer/api-overview/resources/virtual-machine/ title="Virtual Machine" class=dd-item><a href=/farmer/api-overview/resources/virtual-machine/>Virtual Machine</a></li><li data-nav-id=/farmer/api-overview/resources/virtual-hub/ title="Virtual Hub" class=dd-item><a href=/farmer/api-overview/resources/virtual-hub/>Virtual Hub</a></li><li data-nav-id=/farmer/api-overview/resources/vnet/ title="Virtual Network" class=dd-item><a href=/farmer/api-overview/resources/vnet/>Virtual Network</a></li><li data-nav-id=/farmer/api-overview/resources/virtual-wan/ title="Virtual WAN" class=dd-item><a href=/farmer/api-overview/resources/virtual-wan/>Virtual WAN</a></li><li data-nav-id=/farmer/api-overview/resources/vnet-gateway/ title="Virtual Network Gateway" class=dd-item><a href=/farmer/api-overview/resources/vnet-gateway/>Virtual Network Gateway</a></li><li data-nav-id=/farmer/api-overview/resources/vm-scale-set/ title="Virtual Machine Scale Set" class=dd-item><a href=/farmer/api-overview/resources/vm-scale-set/>Virtual Machine Scale Set</a></li><li data-nav-id=/farmer/api-overview/resources/disk/ title=Disk class=dd-item><a href=/farmer/api-overview/resources/disk/>Disk</a></li><li data-nav-id=/farmer/api-overview/resources/web-app/ title="Web App" class=dd-item><a href=/farmer/api-overview/resources/web-app/>Web App</a></li><li data-nav-id=/farmer/api-overview/resources/autoscale-settings/ title="Autoscale Settings" class=dd-item><a href=/farmer/api-overview/resources/autoscale-settings/>Autoscale Settings</a></li></ul></li></ul></li><li data-nav-id=/farmer/arm-vs-farmer/ title="Farmer and ARM" class=dd-item><a href=/farmer/arm-vs-farmer/>Farmer and ARM</a></li><li data-nav-id=/farmer/deployment-guidance/ title="Deployment Guidance" class=dd-item><a href=/farmer/deployment-guidance/>Deployment Guidance</a></li><li data-nav-id=/farmer/support/ title="Commercial Support" class=dd-item><a href=/farmer/support/>Commercial Support</a></li><li data-nav-id=/farmer/testimonials/ title=Testimonials class=dd-item><a href=/farmer/testimonials/>Testimonials</a></li><li data-nav-id=/farmer/links/ title=Links class=dd-item><a href=/farmer/links/>Links</a></li><li data-nav-id=/farmer/contributing/ title=Contributing class=dd-item><a href=/farmer/contributing/>Contributing</a><ul><li data-nav-id=/farmer/contributing/arm-basics/ title="ARM Basics" class=dd-item><a href=/farmer/contributing/arm-basics/>ARM Basics</a></li><li data-nav-id=/farmer/contributing/outputs-and-expressions/ title="Outputs and ARM Expressions" class=dd-item><a href=/farmer/contributing/outputs-and-expressions/>Outputs and ARM Expressions</a></li><li data-nav-id=/farmer/contributing/create-pull-requests/ title="Creating Pull Requests" class=dd-item><a href=/farmer/contributing/create-pull-requests/>Creating Pull Requests</a></li><li data-nav-id=/farmer/contributing/adding-resources/ title="Supporting a new ARM Resource" class=dd-item><a href=/farmer/contributing/adding-resources/>Supporting a new ARM Resource</a><ul><li data-nav-id=/farmer/contributing/adding-resources/1-the-farmer-pipline/ title="1. The Farmer Pipeline" class=dd-item><a href=/farmer/contributing/adding-resources/1-the-farmer-pipline/>1. The Farmer Pipeline</a></li><li data-nav-id=/farmer/contributing/adding-resources/2-iarm-resource/ title="2. The IArmResource" class=dd-item><a href=/farmer/contributing/adding-resources/2-iarm-resource/>2. The IArmResource</a></li><li data-nav-id=/farmer/contributing/adding-resources/3-ibuilder/ title="3. The IBuilder interface" class=dd-item><a href=/farmer/contributing/adding-resources/3-ibuilder/>3. The IBuilder interface</a></li><li data-nav-id=/farmer/contributing/adding-resources/4-creating-builder-syntax/ title="4. Providing Builder syntax" class=dd-item><a href=/farmer/contributing/adding-resources/4-creating-builder-syntax/>4. Providing Builder syntax</a></li><li data-nav-id=/farmer/contributing/adding-resources/5-unit-testing/ title="5. Unit Testing" class=dd-item><a href=/farmer/contributing/adding-resources/5-unit-testing/>5. Unit Testing</a></li></ul></li></ul></li><li data-nav-id=/farmer/faq/ title=FAQs class=dd-item><a href=/farmer/faq/>FAQs</a></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://github.com/compositionalit/farmer><i class="fab fa-fw fa-github"></i>GitHub repo</a></li><li><a class=padding href=https://www.nuget.org/packages/Farmer/><i class="fab fa-fw fa-microsoft"></i>Nuget</a></li><li><a class=padding href=https://compositional-it.com><img src=/farmer/images/cit.png></img> Compositional IT</a></li></ul></section><section id=footer></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/CompositionalIT/farmer/tree/master/docs/content/tutorials/traditional-ea.md target=blank><i class="fas fa-code-branch"></i><span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span><span class=links><a href=/farmer/>Farmer</a> > <a href=/farmer/tutorials/>Tutorials</a> > Traditional Enterprise Application to the Azure Cloud, managed via Farmer</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><ul><li></li><li><a href=#what-next>What next?</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Traditional Enterprise Application to the Azure Cloud, managed via Farmer</h1><h4 id=introduction>Introduction</h4><p>This tutorial shows how to create the basic infrastructure of an enterprise application (for example, migrating old on-premises application to cloud) and then how to build the supporting services for that.</p><p>A traditional enterprise application has database and a server. Farmer supportrs both Microsoft SQL Server and PostgreSQL. This tutorial uses Microsoft version.
For the server, we use a Virtual Machine (VM) which is basically your server in the cloud.</p><figure><img src=../../images/tutorials/enterprise1.png alt="Virtual Machine and SQL Server"><figcaption><p>Virtual Machine and SQL Server</p></figcaption></figure><h4 id=creating-the-deployment-template>Creating the deployment template</h4><p>First we need a template project and a script for the deployment code.
Create a new deployment application:</p><ol><li>Create a directory for your new application and enter it.</li><li>Using the dotnet SDK, create a new console application: <code>dotnet new console -lang F#</code>.</li><li>Install FAKE (which will be using to deploy the database) and Farmer:</li></ol><pre><code class=language-console data-lang=console>dotnet add package Farmer
dotnet add package Fake.Sql.SqlPackage
dotnet add package Fake.DotNet.Cli
dotnet add package Fake.Core.Target
</code></pre><p>Then modify the Program.fs to have the following code:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#66d9ef>open</span> System
<span style=color:#66d9ef>open</span> Fake.Core
<span style=color:#66d9ef>open</span> Fake.Sql
<span style=color:#66d9ef>open</span> Farmer
<span style=color:#66d9ef>open</span> Farmer.Builders
<span style=color:#66d9ef>open</span> Farmer.TrafficManager
<span style=color:#66d9ef>open</span> Farmer.NetworkSecurity

<span style=color:#66d9ef>let</span> execContext <span style=color:#f92672>=</span> Context.FakeExecutionContext.Create <span style=color:#66d9ef>false</span> <span style=color:#e6db74>&#34;build.fsx&#34;</span> <span style=color:#f92672>[</span> <span style=color:#f92672>]</span>
Context.setExecutionContext <span style=color:#f92672>(</span>Context.RuntimeContext.Fake execContext<span style=color:#f92672>)</span>

<span style=color:#66d9ef>let</span> runOrDefault args <span style=color:#f92672>=</span>
    <span style=color:#66d9ef>try</span>
        <span style=color:#66d9ef>match</span> args <span style=color:#66d9ef>with</span>
        <span style=color:#f92672>|</span> <span style=color:#f92672>[|</span> target <span style=color:#f92672>|]</span> <span style=color:#f92672>-&gt;</span> Target.runOrDefault target
        <span style=color:#f92672>|</span> <span style=color:#f92672>_</span> <span style=color:#f92672>-&gt;</span> Target.runOrDefault <span style=color:#e6db74>&#34;All&#34;</span>
        0
    <span style=color:#66d9ef>with</span> e <span style=color:#f92672>-&gt;</span>
        printfn <span style=color:#e6db74>&#34;%A&#34;</span> e
        1

<span style=color:#66d9ef>let</span> mutable dbConnectionString <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#75715e>// to transfer over Fake-tasks.
</span><span style=color:#75715e></span>
<span style=color:#e6db74>/// Create Remote desktop file for VM
</span><span style=color:#e6db74></span><span style=color:#66d9ef>let</span> createRemoteDesktopFile machineName <span style=color:#f92672>(</span>ip<span style=color:#f92672>:</span><span style=color:#66d9ef>string</span><span style=color:#f92672>)</span> loginName <span style=color:#f92672>=</span>
    <span style=color:#66d9ef>if</span> ip<span style=color:#f92672>.</span>Contains <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#66d9ef>then</span> Console.WriteLine <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;Invalid ip: {ip}&#34;</span>
    <span style=color:#66d9ef>else</span>
    <span style=color:#66d9ef>let</span> content <span style=color:#f92672>=</span> <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;full address:s:{ip}:3389</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>username:s:{machineName}</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#e6db74>{loginName}</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>prompt for credentials:i:1</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>administrative session:i:1&#34;</span>
    System.IO.File.WriteAllText<span style=color:#f92672>(</span>machineName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.rdp&#34;</span><span style=color:#f92672>,</span> content<span style=color:#f92672>)</span>

<span style=color:#e6db74>/// Here we will instert the Farmer code to deploy infrastructure
</span><span style=color:#e6db74></span>Target.create <span style=color:#e6db74>&#34;Infrastructure&#34;</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> <span style=color:#f92672>_</span> <span style=color:#f92672>-&gt;</span>
    
    <span style=color:#66d9ef>let</span> deployEnvironment <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Test&#34;</span> <span style=color:#75715e>// &#34;Prod&#34;
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> deployName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TestResourceGroup&#34;</span>
    <span style=color:#66d9ef>let</span> deployLocation <span style=color:#f92672>=</span> Location.WestEurope
    <span style=color:#66d9ef>let</span> envInfo <span style=color:#f92672>=</span> deployEnvironment<span style=color:#f92672>.</span>ToLower()
    printfn <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;Deploying {envInfo} {deployName} to {deployLocation}&#34;</span>

    <span style=color:#75715e>// ---- &lt; Azure SQL &gt; ----------
</span><span style=color:#75715e></span>
    <span style=color:#75715e>// Todo: Insert DB Server code
</span><span style=color:#75715e></span>
    <span style=color:#75715e>// ---- &lt;/Azure SQL &gt; ----------
</span><span style=color:#75715e></span>    <span style=color:#75715e>// ---- &lt; Virtual Machines + NSG &gt; ----------
</span><span style=color:#75715e></span>    
    <span style=color:#75715e>// Todo: Insert VM code
</span><span style=color:#75715e></span>
    <span style=color:#75715e>// ---- &lt;/Virtual Machines + NSG &gt; ----------
</span><span style=color:#75715e></span>
    <span style=color:#75715e>// Todo: Insert Farmer deployment
</span><span style=color:#75715e></span>
    <span style=color:#75715e>// Todo: More resources will follow here...
</span><span style=color:#75715e></span>    ()
<span style=color:#f92672>)</span>

<span style=color:#e6db74>/// Here we will inster the FAKE task to deploy the database to SQL Server
</span><span style=color:#e6db74></span>Target.create <span style=color:#e6db74>&#34;DeployDatabase&#34;</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> <span style=color:#f92672>_</span> <span style=color:#f92672>-&gt;</span>
    
    <span style=color:#75715e>// Todo: Deploy database code
</span><span style=color:#75715e></span>    ()
<span style=color:#f92672>)</span>

Target.create <span style=color:#e6db74>&#34;All&#34;</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> <span style=color:#f92672>_</span> <span style=color:#f92672>-&gt;</span> ()<span style=color:#f92672>)</span>

<span style=color:#66d9ef>open</span> Fake.Core.TargetOperators

<span style=color:#66d9ef>let</span> dependencies <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
            <span style=color:#e6db74>&#34;Infrastructure&#34;</span>
            <span style=color:#f92672>==&gt;</span> <span style=color:#e6db74>&#34;DeployDatabase&#34;</span>
            <span style=color:#f92672>==&gt;</span> <span style=color:#e6db74>&#34;All&#34;</span>
    <span style=color:#f92672>]</span>

<span style=color:#f92672>[&lt;</span>EntryPoint<span style=color:#f92672>&gt;]</span>
<span style=color:#66d9ef>let</span> main args <span style=color:#f92672>=</span> runOrDefault args
</code></pre></div><p>Now, if you run <code>dotnet build</code> and <code>dotnet run</code>, you should see that the both targets, Infrastructure and DeployDatabase, are being called.</p><h4 id=creating-the-database-server-with-an-empty-database>Creating the database server with an empty database</h4><p>Creating <a href=https://azure.microsoft.com/en-us/products/azure-sql/database/>SQL Server database</a>:
Replace <code>// Todo: Insert DB Server code</code> with:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp>    <span style=color:#66d9ef>let</span> dbServerName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;my-db-server321&#34;</span><span style=color:#f92672>.</span>ToLower()
    <span style=color:#66d9ef>let</span> databaseName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;my_database&#34;</span>
    <span style=color:#66d9ef>let</span> dbUsername <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ServerAdmin&#34;</span>
    <span style=color:#66d9ef>let</span> dbPasswordKey <span style=color:#f92672>=</span> <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;password-for-{dbServerName}{envInfo}&#34;</span>
    <span style=color:#66d9ef>let</span> dbPassword <span style=color:#f92672>=</span> Environment.environVarOrFail <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;db-password-{envInfo}&#34;</span>

    <span style=color:#66d9ef>let</span> getMyIp <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> System.Net.WebClient()<span style=color:#f92672>).</span>DownloadString<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;https://api.ipify.org&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#66d9ef>let</span> sqlFirewallRules <span style=color:#f92672>=</span> <span style=color:#75715e>// List of SQL firewall IPs to open:
</span><span style=color:#75715e></span>        <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;Deployment_Farmer_Ip&#34;</span><span style=color:#f92672>,</span> getMyIp
          <span style=color:#75715e>// &#34;Office-ip-2021-09-03&#34;, &#34;123.123.123.123&#34;
</span><span style=color:#75715e></span>        <span style=color:#f92672>]</span>

    <span style=color:#66d9ef>let</span> database <span style=color:#f92672>=</span>
        sqlServer <span style=color:#f92672>{</span>
            name <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;{dbServerName}{envInfo}&#34;</span>
            admin_username dbUsername
            enable_azure_firewall
            add_firewall_rules <span style=color:#f92672>(</span>sqlFirewallRules <span style=color:#f92672>|&gt;</span> List.map<span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> <span style=color:#f92672>(</span>name<span style=color:#f92672>,</span>ip<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span> name<span style=color:#f92672>,</span>ip<span style=color:#f92672>,</span>ip<span style=color:#f92672>))</span>
            add_databases <span style=color:#f92672>[</span> 
                sqlDb <span style=color:#f92672>{</span> 
                    sku Sql.DtuSku.S1<span style=color:#f92672>;</span> 
                    name <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;{databaseName}{deployEnvironment}&#34;</span> <span style=color:#f92672>}</span> <span style=color:#f92672>]</span>
        <span style=color:#f92672>}</span>
</code></pre></div><p>Youc could add</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp>            geo_replicate<span style=color:#f92672>({</span> DbSku <span style=color:#f92672>=</span> Some Sql.DtuSku.S1
                            <span style=color:#75715e>// Some different than the primary location:
</span><span style=color:#75715e></span>                            Location <span style=color:#f92672>=</span> Location.NorthEurope 
                            NameSuffix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;-geo&#34;</span><span style=color:#f92672>})</span>
</code></pre></div><p>&mldr; to geo-replicate the SQL Server database to have a backup on a different location.</p><p>Relevant Farmer API documentation:</p><ul><li><a href=https://compositionalit.github.io/farmer/api-overview/resources/sql/>SQL Server</a></li><li><a href=https://compositionalit.github.io/farmer/api-overview/resources/postgresql/>PostgreSql</a></li></ul><h4 id=creating-virtual-machines>Creating virtual machine(s)</h4><p><a href=https://azure.microsoft.com/en-us/services/virtual-machines/>Virtual Machine</a> will be created as a list with shared Network Security Group (NSG). This allows you to configure the firewall rules once and apply them to all your machines.</p><p>Next, replace the <code>// Todo: Insert VM code</code> with:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp>    <span style=color:#66d9ef>let</span> nsgName <span style=color:#f92672>=</span> <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;myNSG{deployEnvironment}&#34;</span>
    <span style=color:#66d9ef>let</span> vmNamePrefix<span style=color:#f92672>,</span> vmCount <span style=color:#f92672>=</span> <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;MyVm{deployEnvironment}&#34;</span><span style=color:#f92672>,</span> 1
    <span style=color:#66d9ef>let</span> vmUsername <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;MyAdmin&#34;</span>
    <span style=color:#66d9ef>let</span> vmPassword <span style=color:#f92672>=</span> Environment.environVarOrFail <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;vm-password-{envInfo}&#34;</span>
    <span style=color:#66d9ef>let</span> vmHttpPorts <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>443<span style=color:#f92672>]</span>

    <span style=color:#e6db74>/// Open http ports
</span><span style=color:#e6db74></span>    <span style=color:#66d9ef>let</span> httpsRule <span style=color:#f92672>=</span> securityRule <span style=color:#f92672>{</span>
        name <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;{vmNamePrefix}HttpsRule&#34;</span>
        services <span style=color:#f92672>(</span>vmHttpPorts <span style=color:#f92672>|&gt;</span> List.map<span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> p <span style=color:#f92672>-&gt;</span> NetworkService <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;http&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>uint16</span> p <span style=color:#f92672>|&gt;</span> Port<span style=color:#f92672>)))</span>
        add_source_tag NetworkProtocol.TCP <span style=color:#e6db74>&#34;Internet&#34;</span>
        add_destination_any
    <span style=color:#f92672>}</span>

    <span style=color:#e6db74>/// Open https port
</span><span style=color:#e6db74></span>    <span style=color:#66d9ef>let</span> httpRule <span style=color:#f92672>=</span> securityRule <span style=color:#f92672>{</span>
        name <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;{vmNamePrefix}HttpRule&#34;</span>
        services <span style=color:#f92672>[</span>NetworkService <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;http&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>uint16</span> 80 <span style=color:#f92672>|&gt;</span> Port<span style=color:#f92672>)]</span>
        add_source_tag NetworkProtocol.TCP <span style=color:#e6db74>&#34;Internet&#34;</span>
        add_destination_any
    <span style=color:#f92672>}</span>

    <span style=color:#e6db74>/// Allowed ports for VM:
</span><span style=color:#e6db74></span>    <span style=color:#66d9ef>let</span> vmIpRules <span style=color:#f92672>=</span> <span style=color:#75715e>// rule name, ip address, allow RDP 
</span><span style=color:#75715e></span>        <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;Deployment_Farmer_Ip&#34;</span><span style=color:#f92672>,</span> getMyIp<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span>
          <span style=color:#75715e>// &#34;Office-ip-2021-09-03&#34;, &#34;123.123.123.123&#34;, false
</span><span style=color:#75715e></span>        <span style=color:#f92672>]</span> <span style=color:#f92672>|&gt;</span> List.map<span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> <span style=color:#f92672>(</span>nm<span style=color:#f92672>,</span> ip<span style=color:#f92672>,</span> remote<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span>
                securityRule <span style=color:#f92672>{</span>
                    name nm
                    services <span style=color:#f92672>(</span>seq <span style=color:#f92672>{</span>
                        <span style=color:#75715e>// yield &#34;CustomServicePortToOpen&#34;, 12345;
</span><span style=color:#75715e></span>                        <span style=color:#66d9ef>if</span> remote <span style=color:#66d9ef>then</span> <span style=color:#66d9ef>yield</span> <span style=color:#e6db74>&#34;rdp&#34;</span><span style=color:#f92672>,</span> 3389<span style=color:#f92672>;</span> 
                        <span style=color:#f92672>})</span>
                    add_source_address NetworkProtocol.TCP ip
                    add_destination_any
                <span style=color:#f92672>})</span>

    <span style=color:#66d9ef>let</span> networkSecurityGroup <span style=color:#f92672>=</span> nsg <span style=color:#f92672>{</span>
        name nsgName
        add_rules <span style=color:#f92672>(</span>httpsRule <span style=color:#f92672>::</span> httpRule <span style=color:#f92672>::</span> vmIpRules<span style=color:#f92672>)</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>let</span> createVm <span style=color:#f92672>(</span>vmName<span style=color:#f92672>:</span><span style=color:#66d9ef>string</span><span style=color:#f92672>)</span> <span style=color:#f92672>=</span>
        vm <span style=color:#f92672>{</span>
            name vmName
            network_security_group networkSecurityGroup
            username vmUsername
            os_disk 128 Vm.StandardSSD_LRS
            system_identity
            vm_size Vm.VMSize.Standard_DS1_v2
            operating_system Vm.WindowsServer_2019Datacenter
            ip_allocation PublicIpAddress.Static
        <span style=color:#f92672>}</span>
    <span style=color:#66d9ef>let</span> vms <span style=color:#f92672>=</span> <span style=color:#f92672>[</span> 1<span style=color:#f92672>..</span> vmCount<span style=color:#f92672>]</span> <span style=color:#f92672>|&gt;</span> List.map<span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> idx <span style=color:#f92672>-&gt;</span> createVm<span style=color:#f92672>($</span><span style=color:#e6db74>&#34;{vmNamePrefix}{idx}&#34;</span><span style=color:#f92672>))</span>
    <span style=color:#66d9ef>let</span> vmPwdKeys <span style=color:#f92672>=</span> <span style=color:#f92672>[</span> 1<span style=color:#f92672>..</span> vmCount<span style=color:#f92672>]</span> <span style=color:#f92672>|&gt;</span> List.map<span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> idx <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;password-for-{vmNamePrefix}{idx}&#34;</span><span style=color:#f92672>,</span> vmPassword<span style=color:#f92672>)</span>
</code></pre></div><p>You could merge the sqlFirewallRules and vmIpRules, but this depends on your setup.</p><p>Relevant Farmer API documentation:</p><ul><li><a href=https://compositionalit.github.io/farmer/api-overview/resources/virtual-machine/>Virtual Machine</a></li></ul><h4 id=farmer-deployment-of-the-resources>Farmer deployment of the resources</h4><p>Next, replace the <code>// Todo: Insert Farmer deployment</code> with:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp>    <span style=color:#66d9ef>let</span> deployment <span style=color:#f92672>=</span> arm <span style=color:#f92672>{</span>
        location deployLocation
        add_resource database
        add_resource networkSecurityGroup
        add_resources <span style=color:#f92672>(</span>virtualMachines <span style=color:#f92672>|&gt;</span> List.map<span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> vm <span style=color:#f92672>-&gt;</span> vm <span style=color:#f92672>:&gt;</span> IBuilder<span style=color:#f92672>))</span>
        output <span style=color:#e6db74>&#34;db-connStr&#34;</span> <span style=color:#f92672>(</span>database<span style=color:#f92672>.</span>Databases <span style=color:#f92672>|&gt;</span> Seq.tryHead <span style=color:#f92672>|&gt;</span> Option.map<span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> db <span style=color:#f92672>-&gt;</span> database<span style=color:#f92672>.</span>ConnectionString db<span style=color:#f92672>.</span>Name<span style=color:#f92672>))</span>
        outputs <span style=color:#f92672>(</span>virtualMachines 
                 <span style=color:#f92672>|&gt;</span> List.filter <span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> vm <span style=color:#f92672>-&gt;</span> vm<span style=color:#f92672>.</span>PublicIpAddress<span style=color:#f92672>.</span>IsSome<span style=color:#f92672>)</span>
                 <span style=color:#f92672>|&gt;</span> List.mapi <span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> idx vm <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;{vmNamePrefix}{idx+1}&#34;</span><span style=color:#f92672>,</span> vm<span style=color:#f92672>.</span>PublicIpAddress<span style=color:#f92672>.</span>Value<span style=color:#f92672>))</span>
    <span style=color:#f92672>}</span>

    <span style=color:#75715e>// To check the ARM generated:
</span><span style=color:#75715e></span>    deployment <span style=color:#f92672>|&gt;</span> Writer.quickWrite <span style=color:#e6db74>&#34;myTemplate&#34;</span>
    
    <span style=color:#75715e>// To check the changes in Azure:
</span><span style=color:#75715e></span>    <span style=color:#75715e>//let changes = deployment |&gt; Deploy.whatIf deployName ([dbPasswordKey, dbPassword] @ vmPwdKeys)
</span><span style=color:#75715e></span>    <span style=color:#75715e>//System.IO.File.WriteAllText(@&#34;Changes.txt&#34;, changes)
</span><span style=color:#75715e></span>
    <span style=color:#75715e>//let outputs = Map.empty&lt;string,string&gt;
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> outputs <span style=color:#f92672>=</span>
        deployment
        <span style=color:#f92672>|&gt;</span> Deploy.execute
            deployName
            <span style=color:#f92672>([</span>dbPasswordKey<span style=color:#f92672>,</span> dbPassword<span style=color:#f92672>]</span> <span style=color:#f92672>@</span> vmPwdKeys<span style=color:#f92672>)</span>

    Console.ForegroundColor <span style=color:#f92672>&lt;-</span> ConsoleColor.Blue
    <span style=color:#66d9ef>if</span> outputs<span style=color:#f92672>.</span>ContainsKey <span style=color:#e6db74>&#34;db-connStr&#34;</span> <span style=color:#66d9ef>then</span>
        <span style=color:#66d9ef>let</span> connStr <span style=color:#f92672>=</span> outputs<span style=color:#f92672>.[</span><span style=color:#e6db74>&#34;db-connStr&#34;</span><span style=color:#f92672>]</span>
        dbConnectionString <span style=color:#f92672>&lt;-</span> connStr<span style=color:#f92672>.</span>Replace<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;=tcp:&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;=&#34;</span><span style=color:#f92672>)</span>

    virtualMachines <span style=color:#f92672>|&gt;</span> List.iteri<span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> idx <span style=color:#f92672>_</span> <span style=color:#f92672>-&gt;</span>
        <span style=color:#66d9ef>if</span> outputs<span style=color:#f92672>.</span>ContainsKey <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;vmIP{idx+1}&#34;</span> <span style=color:#66d9ef>then</span>
            Console.WriteLine <span style=color:#f92672>($</span><span style=color:#e6db74>&#34;VM{idx+1} IP: &#34;</span> <span style=color:#f92672>+</span> outputs<span style=color:#f92672>.[$</span><span style=color:#e6db74>&#34;vmIP{idx+1}&#34;</span><span style=color:#f92672>])</span>
            createRemoteDesktopFile <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;{vmNamePrefix}{idx+1}&#34;</span> outputs<span style=color:#f92672>.[$</span><span style=color:#e6db74>&#34;vmIP{idx+1}&#34;</span><span style=color:#f92672>]</span> vmUsername
    <span style=color:#f92672>)</span>
    Console.ResetColor()
</code></pre></div><p>Before you can run this script, you have to set the environment varialbles of passwords for VM and DB.</p><p>The complexity rules for VM-password: Supplied password must be between 8-123 characters long and must satisfy at least 3 of password complexity requirements from the following:</p><ol><li>Contains an uppercase character</li><li>Contains a lowercase character</li><li>Contains a numeric digit</li><li>Contains a special character</li><li>Control characters are not allowed</li></ol><p>To set environment variables you can do e.g.:</p><pre><code class=language-console data-lang=console>set vm-password-test=...
set db-password-test=...
</code></pre><p>Because the deployments are repeateable, you can already <code>dotnet build</code> and <code>dotnet run</code> the script.</p><h4 id=deploying-the-database-schema>Deploying the Database Schema</h4><p>A typical way to store, version-control, manage and compare Microsoft SQL Server database schemas is the SQL Server Data Tools (SSDT).
Given a connection string, SSDT will create a local snapshot of a database, copying all of the tables, views, stored procedures, etc. into your source code repository as .sql-files.
The .sql-files will be in a &ldquo;.sqlproj&rdquo; project that is compiled into a .dacpac-file.</p><p>You can get SSDT for <a href="https://docs.microsoft.com/en-us/sql/ssdt/download-sql-server-data-tools-ssdt?view=sql-server-ver15">Visual Studio 2019</a> or Azure Data Studio via the SQL Database Projects Extension.</p><p>For non-Windows machine you can build a dacpac file by creating a normal .fsproj class library, and changing it to use Sdk <code>&lt;Project Sdk="MSBuild.Sdk.SqlProj/1.16.2"></code> as described in <a href=https://erikej.github.io/efcore/2020/05/11/ssdt-dacpac-netcore.html>here</a> with <a href=https://github.com/rr-wfm/MSBuild.Sdk.SqlProj>more details</a>.</p><p>Farmer has deployed an empty database for you (or updated the existing settings), but now you would want to insert/update the database schema, tables, procedures, etc.</p><p>A way to install the dacpac-file to created database (or do a schema comparison), is using <a href=https://fake.build/sql-sqlpackage.html>FAKE</a>.</p><p>Let&rsquo;s replace the part <code>// Todo: Deploy database code</code> with:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp>    <span style=color:#75715e>// You need the .dacpac file:
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> dacPacPath <span style=color:#f92672>=</span> System.IO.Path.Combine <span style=color:#f92672>[|__</span>SOURCE_DIRECTORY__ <span style=color:#f92672>;</span><span style=color:#e6db74>&#34;find_your_dacpac_file_path&#34;</span> <span style=color:#f92672>;</span> <span style=color:#e6db74>&#34;database.dacpac&#34;</span> <span style=color:#f92672>|]</span>
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> <span style=color:#f92672>(</span>System.IO.File.Exists dacPacPath<span style=color:#f92672>)</span> <span style=color:#66d9ef>then</span>
        failwithf <span style=color:#e6db74>&#34;DacPac file not found: %s&#34;</span> dacPacPath
    <span style=color:#66d9ef>else</span>

    <span style=color:#66d9ef>let</span> connectionString <span style=color:#f92672>=</span>
        <span style=color:#66d9ef>let</span> conn <span style=color:#f92672>=</span> dbConnectionString
        <span style=color:#66d9ef>if</span> conn<span style=color:#f92672>.</span>StartsWith <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>&amp;&amp;</span> conn<span style=color:#f92672>.</span>EndsWith <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span> <span style=color:#66d9ef>then</span>
            conn<span style=color:#f92672>.</span>Substring<span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> conn<span style=color:#f92672>.</span>Length<span style=color:#f92672>-</span>2<span style=color:#f92672>)</span>
        <span style=color:#66d9ef>else</span> conn

    printfn <span style=color:#e6db74>&#34;Deploying db connection: %s&#34;</span> connectionString

    <span style=color:#75715e>// Example of custom parameters for SQLPROJ deployment:
</span><span style=color:#75715e></span>    <span style=color:#75715e>// let demodata = if deployEnvironment = &#34;Test&#34; then &#34;True&#34; else &#34;False&#34;
</span><span style=color:#75715e></span>
    SqlPackage.deployDb <span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> args <span style=color:#f92672>-&gt;</span>
        <span style=color:#f92672>{</span> args <span style=color:#66d9ef>with</span>
            <span style=color:#75715e>//Action = SqlPackage.DeployAction.Report &#34;database-diff.xml&#34; //This would only show diff. The default action: Deploy
</span><span style=color:#75715e></span>            Source <span style=color:#f92672>=</span> dacPacPath<span style=color:#f92672>;</span>
            Destination <span style=color:#f92672>=</span> connectionString
            <span style=color:#75715e>// Variables = [ &#34;DeployDemoData&#34;, demodata ]
</span><span style=color:#75715e></span>            AdditionalSqlPackageProperties <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
                <span style=color:#e6db74>&#34;IgnorePermissions&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;true&#34;</span>
                <span style=color:#e6db74>&#34;IgnoreUserSettingsObjects&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;true&#34;</span>
                <span style=color:#e6db74>&#34;IgnoreLoginSids&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;true&#34;</span>
                <span style=color:#e6db74>&#34;IgnoreRoleMembership&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;true&#34;</span>
                <span style=color:#75715e>// Depending on your dacpac, you might want to exclude some objects:
</span><span style=color:#75715e></span>                <span style=color:#e6db74>&#34;ExcludeObjectTypes&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Users;Logins;RoleMembership;ServerRoleMembership;Permissions&#34;</span><span style=color:#f92672>;</span>
            <span style=color:#f92672>]</span>
            Timeout <span style=color:#f92672>=</span> Some 240
        <span style=color:#f92672>})</span> <span style=color:#f92672>|&gt;</span> ignore
</code></pre></div><h3 id=what-next>What next?</h3><p>There is a <code>Todo: More resources will follow here...</code> for you to continue infrastructure development with Farmer.
Other resources that are useful:</p><ul><li><a href=https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview>Application Insights</a>, to attach monitoring: alerts, dashboards, availability tests.</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp>    <span style=color:#66d9ef>let</span> ai <span style=color:#f92672>=</span> appInsights <span style=color:#f92672>{</span>
        name <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;{deployName}{deployEnvironment}AppInsights&#34;</span>
    <span style=color:#f92672>}</span>
</code></pre></div><ul><li><a href=https://docs.microsoft.com/en-us/azure/traffic-manager/traffic-manager-overview>Azure Traffic Manager</a> is a DNS-based traffic load balancer. It means you can route the traffic to globally different regions and there is no performance hit of the traditional load balancer routing the traffic. The traffic manager will route the traffic to your VMs.</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp>    <span style=color:#66d9ef>let</span> dependsOnIps <span style=color:#f92672>=</span> 
        virtualMachines
        <span style=color:#f92672>|&gt;</span> List.filter<span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> vm <span style=color:#f92672>-&gt;</span> vm<span style=color:#f92672>.</span>PublicIpId<span style=color:#f92672>.</span>IsSome<span style=color:#f92672>)</span>
        <span style=color:#f92672>|&gt;</span> List.map<span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> vm <span style=color:#f92672>-&gt;</span> vm<span style=color:#f92672>.</span>PublicIpId<span style=color:#f92672>.</span>Value<span style=color:#f92672>)</span> 
    <span style=color:#66d9ef>let</span> trafficMgr <span style=color:#f92672>=</span> trafficManager <span style=color:#f92672>{</span>
        name <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;TrafficManager2392{deployEnvironment}&#34;</span> <span style=color:#75715e>// has to be unique name
</span><span style=color:#75715e></span>        depends_on dependsOnIps
        depends_on <span style=color:#f92672>(</span>virtualMachines <span style=color:#f92672>|&gt;</span> List.map<span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> vm <span style=color:#f92672>-&gt;</span> vm <span style=color:#f92672>:&gt;</span> IBuilder<span style=color:#f92672>))</span>
        add_endpoints 
            <span style=color:#f92672>(</span>virtualMachines
             <span style=color:#f92672>|&gt;</span> List.filter<span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> vm <span style=color:#f92672>-&gt;</span> vm<span style=color:#f92672>.</span>PublicIpAddress<span style=color:#f92672>.</span>IsSome<span style=color:#f92672>)</span>
             <span style=color:#f92672>|&gt;</span> List.mapi<span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> i <span style=color:#f92672>(</span>vm<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span>
                TrafficManager.endpoint <span style=color:#f92672>{</span>
                    name vm<span style=color:#f92672>.</span>Name
                    weight 1
                    priority <span style=color:#f92672>(</span>i<span style=color:#f92672>+</span>1<span style=color:#f92672>)</span>
                    target_external <span style=color:#f92672>(</span>vm<span style=color:#f92672>.</span>PublicIpAddress<span style=color:#f92672>.</span>Value<span style=color:#f92672>.</span>Eval()<span style=color:#f92672>)</span> deployLocation 
                <span style=color:#f92672>}))</span>
        enable_traffic_view
        routing_method RoutingMethod.Priority <span style=color:#75715e>// Set your routing method here
</span><span style=color:#75715e></span>        dns_ttl 60<span style=color:#f92672>&lt;</span>Seconds<span style=color:#f92672>&gt;</span>
        monitor_protocol Https
        monitor_port 443
    <span style=color:#f92672>}</span>

</code></pre></div><ul><li><a href=https://docs.microsoft.com/en-us/azure/dns/dns-overview>Azure DNS</a>: The benefit of Azure DNS comes when you want to have a version history of your domain name settings, you want to programmatically manage the DNS to e.g. automatically verify SSL-certifiaction renewal, and route the traffic to Azure Traffic Manager.</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp>    <span style=color:#66d9ef>let</span> dnsZoneName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;mydomain321.com&#34;</span> <span style=color:#75715e>// Your domain here
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> dns <span style=color:#f92672>=</span> dnsZone <span style=color:#f92672>{</span>
        name dnsZoneName
        zone_type Dns.Public
        depends_on trafficMgr
        add_records <span style=color:#f92672>[</span>
            txtRecord <span style=color:#f92672>{</span>
                ttl 3600
                add_values <span style=color:#f92672>[</span>
                    <span style=color:#75715e>// Check your current domain with: nslookup -type=txt mydomain.com
</span><span style=color:#75715e></span>                    <span style=color:#75715e>//&#34;asdf=1234&#34;
</span><span style=color:#75715e></span>                <span style=color:#f92672>]</span>
            <span style=color:#f92672>}</span>
            <span style=color:#75715e>//cnameRecord {
</span><span style=color:#75715e></span>            <span style=color:#75715e>//    name &#34;subsite&#34;
</span><span style=color:#75715e></span>            <span style=color:#75715e>//    ttl 3600
</span><span style=color:#75715e></span>            <span style=color:#75715e>//    cname &#34;www.internet.com&#34;
</span><span style=color:#75715e></span>            <span style=color:#75715e>//}
</span><span style=color:#75715e></span>            <span style=color:#75715e>// add mx and cname records from your current DNS...
</span><span style=color:#75715e></span>            <span style=color:#66d9ef>yield</span><span style=color:#f92672>!</span>
              <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>;</span> <span style=color:#e6db74>&#34;de&#34;</span><span style=color:#f92672>;</span> <span style=color:#e6db74>&#34;es&#34;</span><span style=color:#f92672>;</span> <span style=color:#e6db74>&#34;fr&#34;</span><span style=color:#f92672>;</span> <span style=color:#e6db74>&#34;www&#34;</span> <span style=color:#f92672>]</span>
                  <span style=color:#f92672>|&gt;</span> List.fold<span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> gathered nm <span style=color:#f92672>-&gt;</span>
                     <span style=color:#66d9ef>if</span> nm <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#66d9ef>then</span>
                        aRecord <span style=color:#f92672>{</span>
                            ttl 60
                            link_to_dns_zone <span style=color:#f92672>(</span>Arm.Dns.zones<span style=color:#f92672>.</span>resourceId dnsZoneName<span style=color:#f92672>)</span>
                            target_resource trafficMgr
                        <span style=color:#f92672>}</span> <span style=color:#f92672>::</span> gathered
                     <span style=color:#66d9ef>else</span>
                        cnameRecord <span style=color:#f92672>{</span>
                          name nm
                          depends_on <span style=color:#f92672>(</span>gathered <span style=color:#f92672>|&gt;</span> List.head<span style=color:#f92672>)</span>
                          link_to_dns_zone <span style=color:#f92672>(</span>Arm.Dns.zones<span style=color:#f92672>.</span>resourceId dnsZoneName<span style=color:#f92672>)</span>
                          ttl 3600
                          target_resource trafficMgr 
                        <span style=color:#f92672>}</span> <span style=color:#f92672>::</span> gathered<span style=color:#f92672>)</span> []
        <span style=color:#f92672>]</span>
    <span style=color:#f92672>}</span>
</code></pre></div><ul><li><a href=https://azure.microsoft.com/en-us/services/cdn/>Azure CDN</a> will mirror your public static files to a global fast content delivery network. If you reference the files from that, you will get faster delivery and release some resources from your server(s)/VM(s).</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp>    <span style=color:#66d9ef>let</span> contentDelivery <span style=color:#f92672>=</span> cdn <span style=color:#f92672>{</span>
        name <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;{deployName}{deployEnvironment}Cdn&#34;</span>
        sku Cdn.Sku.Standard_Verizon
        add_endpoints <span style=color:#f92672>[</span>
            endpoint <span style=color:#f92672>{</span>
                name <span style=color:#f92672>(</span>dnsZoneName<span style=color:#f92672>.</span>Replace<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.com&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;com&#34;</span><span style=color:#f92672>).</span>Replace<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.&#34;</span><span style=color:#f92672>,</span><span style=color:#e6db74>&#34;-&#34;</span><span style=color:#f92672>))</span>
                <span style=color:#75715e>// add_compressed_content [ &#34;text/plain&#34;; ... ] // Custom mime-types
</span><span style=color:#75715e></span>                enable_http
                enable_https
                query_string_caching_behaviour Cdn.QueryStringCachingBehaviour.IgnoreQueryString
                optimise_for Cdn.GeneralWebDelivery
                origin dnsZoneName
            <span style=color:#f92672>}</span> 
        <span style=color:#f92672>]</span>
    <span style=color:#f92672>}</span>

</code></pre></div><p>After adding these, you have to modify the deployment, e.g.:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp>    <span style=color:#66d9ef>let</span> deployment <span style=color:#f92672>=</span> arm <span style=color:#f92672>{</span>
        location deployLocation
        add_resource ai <span style=color:#75715e>// added
</span><span style=color:#75715e></span>        add_resource contentDelivery <span style=color:#75715e>//added
</span><span style=color:#75715e></span>        add_resource dns <span style=color:#75715e>//added
</span><span style=color:#75715e></span>        add_resource trafficMgr <span style=color:#75715e>//added
</span><span style=color:#75715e></span>        add_resource database
        add_resource networkSecurityGroup
        add_resources <span style=color:#f92672>(</span>virtualMachines <span style=color:#f92672>|&gt;</span> List.map<span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> vm <span style=color:#f92672>-&gt;</span> vm <span style=color:#f92672>:&gt;</span> IBuilder<span style=color:#f92672>))</span>
        output <span style=color:#e6db74>&#34;db-connStr&#34;</span> <span style=color:#f92672>(</span>database<span style=color:#f92672>.</span>Databases <span style=color:#f92672>|&gt;</span> Seq.tryHead <span style=color:#f92672>|&gt;</span> Option.map<span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> db <span style=color:#f92672>-&gt;</span> database<span style=color:#f92672>.</span>ConnectionString db<span style=color:#f92672>.</span>Name<span style=color:#f92672>))</span>
        outputs <span style=color:#f92672>(</span>virtualMachines 
                 <span style=color:#f92672>|&gt;</span> List.filter <span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> vm <span style=color:#f92672>-&gt;</span> vm<span style=color:#f92672>.</span>PublicIpAddress<span style=color:#f92672>.</span>IsSome<span style=color:#f92672>)</span>
                 <span style=color:#f92672>|&gt;</span> List.mapi <span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> idx vm <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;{vmNamePrefix}{idx+1}&#34;</span><span style=color:#f92672>,</span> vm<span style=color:#f92672>.</span>PublicIpAddress<span style=color:#f92672>.</span>Value<span style=color:#f92672>))</span>
        output <span style=color:#e6db74>&#34;appInsights-InstrumentationKey&#34;</span> ai<span style=color:#f92672>.</span>InstrumentationKey <span style=color:#75715e>//added, outputs.[&#34;appInsights-InstrumentationKey&#34;], you need this to send events to AI
</span><span style=color:#75715e></span>        output <span style=color:#e6db74>&#34;dns-nameServers&#34;</span> dns<span style=color:#f92672>.</span>NameServers <span style=color:#75715e>//added, outputs.[&#34;dns-nameServers&#34;], you need these to register your domain.
</span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</code></pre></div><figure><img src=../../images/tutorials/enterprise2.png alt="Supporting resources"><figcaption><p>Supporting resources</p></figcaption></figure><p>Relevant Farmer API documentation:</p><ul><li><a href=https://compositionalit.github.io/farmer/api-overview/resources/dns/>DNS</a></li><li><a href=https://compositionalit.github.io/farmer/api-overview/resources/traffic-manager/>Traffic Manager</a></li><li><a href=https://compositionalit.github.io/farmer/api-overview/resources/cdn/>CDN</a></li><li><a href=https://compositionalit.github.io/farmer/api-overview/resources/dashboard/>AppInsights - Dashboards</a></li><li><a href=https://compositionalit.github.io/farmer/api-overview/resources/alert/>AppInsights - Alerts</a></li><li><a href=https://compositionalit.github.io/farmer/api-overview/resources/availability-tests/>AppInsights - AvailabilityTests</a></li></ul><h4 id=connecting-the-vms>Connecting the VMs</h4><p>If you want to manually connect VMs, this script already created remote desktop connection files for you.
If you want to automatically run scripts in VMs, you can do it e.g. with <a href=https://docs.microsoft.com/en-us/azure/virtual-machines/windows/run-command><code>Invoke-AzVMRunCommand</code></a>,
but you need to have <a href=https://docs.microsoft.com/en-us/cli/azure/install-azure-cli>Azure Cli</a> installed and connected (<code>powershell -ExecutionPolicy Unrestricted -Command "Connect-AzAccount -Force</code>):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp>    <span style=color:#66d9ef>let</span> runShell <span style=color:#f92672>=</span> <span style=color:#66d9ef>fun</span> <span style=color:#f92672>(</span>command<span style=color:#f92672>,</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span>
        <span style=color:#66d9ef>try</span>
            <span style=color:#66d9ef>let</span> P <span style=color:#f92672>=</span> System.Diagnostics.Process.Start<span style=color:#f92672>(</span>command<span style=color:#f92672>,</span> <span style=color:#f92672>(</span>args <span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span><span style=color:#f92672>))</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>P <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>then</span> <span style=color:#f92672>(</span>
                printf <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n\r\n</span><span style=color:#e6db74>Failed: %s</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span> command
            <span style=color:#f92672>)</span>
            P.WaitForExit()<span style=color:#f92672>;</span>
            <span style=color:#66d9ef>if</span> P.ExitCode <span style=color:#f92672>&lt;&gt;</span> 0 <span style=color:#66d9ef>then</span> failwith <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Command failed, try running manually: &#34;</span> <span style=color:#f92672>+</span> command <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>+</span> args<span style=color:#f92672>)</span>
        <span style=color:#66d9ef>with</span>
        <span style=color:#f92672>|</span> <span style=color:#f92672>:?</span> System.ComponentModel.Win32Exception <span style=color:#f92672>-&gt;</span>
            printf <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r\n\r\n</span><span style=color:#e6db74>Failed: %s</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span> command
            reraise ()

    Console.WriteLine <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;VM installation started at &#34;</span> <span style=color:#f92672>+</span> DateTime.Now.ToLongTimeString()<span style=color:#f92672>)</span>
    Console.ForegroundColor <span style=color:#f92672>&lt;-</span> ConsoleColor.DarkGray
    virtualMachines
    <span style=color:#f92672>|&gt;</span> List.iter <span style=color:#f92672>(</span><span style=color:#66d9ef>fun</span> <span style=color:#f92672>(</span>vm<span style=color:#f92672>)</span> <span style=color:#f92672>-&gt;</span>
        Console.WriteLine <span style=color:#f92672>($</span><span style=color:#e6db74>&#34;Installing VM: {vm.Name.Value} &#34;</span> <span style=color:#f92672>+</span> DateTime.Now.ToLongTimeString()<span style=color:#f92672>)</span>
        <span style=color:#66d9ef>let</span> installVMCmd <span style=color:#f92672>=</span> 
            <span style=color:#e6db74>&#34;Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope Process; Install-Module -Name Az.Compute &#34;</span> <span style=color:#f92672>+</span>
            <span style=color:#e6db74>&#34;-Scope CurrentUser -Force -AllowClobber; Import-Module Az.Compute;&#34;</span> <span style=color:#f92672>+</span>
            <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;Invoke-AzVMRunCommand -ResourceGroupName &#39;{deployName}&#39; -Name &#39;{vm.Name.Value}&#39; &#34;</span> <span style=color:#f92672>+</span>
            <span style=color:#e6db74>&#34;-CommandId &#39;RunPowerShellScript&#39; -ScriptPath &#39;./installStuff.ps1&#39; -Parameter @{{myScriptParam1=&#39;hello&#39;;myScriptParam2=&#39;hello2&#39;}}&#34;</span>

        Console.ForegroundColor <span style=color:#f92672>&lt;-</span> ConsoleColor.DarkGray
        runShell<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;powershell&#34;</span><span style=color:#f92672>,$</span><span style=color:#e6db74>&#34;-ExecutionPolicy Unrestricted -Command </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>{installVMCmd}</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#f92672>)</span>
    Console.ResetColor()
    Console.WriteLine <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;VM installation complete at &#34;</span> <span style=color:#f92672>+</span> DateTime.Now.ToLongTimeString()<span style=color:#f92672>)</span>
</code></pre></div><p>You have the <code>installStuff.ps1</code> locally, and then <code>Invoke-AzVMRunCommand</code> will transfer it to the VM automatically and execute the commands.
The path it transfers the script will be something like <code>C:\Packages\Plugins\Microsoft.CPlat.Core.RunCommandWindows\(version)\Downloads\script0.ps1</code>.
Example of the file content what you could have in your <code>installStuff.ps1</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Do whatever installations here...</span>
<span style=color:#75715e># Some parameters:</span>
<span style=color:#66d9ef>param</span> ($myScriptParam1, $myScriptParam2)
<span style=color:#75715e># Some variables:</span>
$httpPortToOpen = 80
$httpsPortsToOpen = 443,12345

<span style=color:#75715e># Save current directory</span>
pushd

<span style=color:#75715e># Install Nuget</span>
Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force

<span style=color:#75715e>#Show file extensions</span>
reg add HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced /v HideFileExt /t REG_DWORD /d 0 /f

<span style=color:#75715e>#Install chocolatey</span>
iex ((new-object net.webclient).DownloadString(<span style=color:#e6db74>&#39;https://chocolatey.org/install.ps1&#39;</span>))

<span style=color:#75715e>#Install dotnet</span>
cd ${Env<span style=color:#960050;background-color:#1e0010>:</span>ALLUSERSPROFILE}\chocolatey\bin
.\choco.exe install dotnet -y

<span style=color:#75715e>#Go back to original directory</span>
Pop-Location

<span style=color:#75715e>#Open Windows firewall ports</span>
netsh advfirewall firewall add rule name=<span style=color:#e6db74>&#34;Open Port HTTP $httpPortToOpen&#34;</span> dir=<span style=color:#66d9ef>in</span> action=allow protocol=TCP localport=$httpPortToOpen
<span style=color:#66d9ef>Foreach</span> ($httpPortToOpen <span style=color:#66d9ef>in</span> $httpPortsToOpen)
{
    netsh advfirewall firewall add rule name=<span style=color:#e6db74>&#34;Open Port HTTPS $httpsPortToOpen&#34;</span> dir=<span style=color:#66d9ef>in</span> action=allow protocol=TCP localport=$httpsPortToOpen
}
<span style=color:#75715e>#...and so on...</span>
</code></pre></div><p>Keep the security in mind when installing stuff to your VMs.
Happy managing!</p><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=/farmer/tutorials/ title=Tutorials><i class="fa fa-chevron-left"></i></a><a class="nav nav-next" href=/farmer/tutorials/webapp-deploy/ title="Deploy an ASP.NET app" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/farmer/js/clipboard.min.js?1724811008></script><script src=/farmer/js/perfect-scrollbar.min.js?1724811008></script><script src=/farmer/js/perfect-scrollbar.jquery.min.js?1724811008></script><script src=/farmer/js/jquery.sticky.js?1724811008></script><script src=/farmer/js/featherlight.min.js?1724811008></script><script src=/farmer/js/highlight.pack.js?1724811008></script><script>hljs.initHighlightingOnLoad();</script><script src=/farmer/js/modernizr.custom-3.6.0.js?1724811008></script><script src=/farmer/js/learn.js?1724811008></script><script src=/farmer/js/hugo-learn.js?1724811008></script><link href=/farmer/mermaid/mermaid.css?1724811008 rel=stylesheet><script src=/farmer/mermaid/mermaid.js?1724811008></script><script>mermaid.initialize({startOnLoad:true});</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-72817248-3','auto');ga('send','pageview');</script></body></html>