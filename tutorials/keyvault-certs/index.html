<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.68.3"><meta name=description content="Farmer - Making repeatable Azure deployments easy!"><link rel=icon href=/farmer/images/farmer-favicon.png type=image/png><title>Declarative Steps in an ARM Deployment :: Farmer</title><link href=/farmer/css/nucleus.css?1757294257 rel=stylesheet><link href=/farmer/css/fontawesome-all.min.css?1757294257 rel=stylesheet><link href=/farmer/css/hybrid.css?1757294257 rel=stylesheet><link href=/farmer/css/featherlight.min.css?1757294257 rel=stylesheet><link href=/farmer/css/perfect-scrollbar.min.css?1757294257 rel=stylesheet><link href=/farmer/css/auto-complete.css?1757294257 rel=stylesheet><link href=/farmer/css/atom-one-dark-reasonable.css?1757294257 rel=stylesheet><link href=/farmer/css/theme.css?1757294257 rel=stylesheet><link href=/farmer/css/hugo-theme.css?1757294257 rel=stylesheet><link href=/farmer/css/theme-green.css?1757294257 rel=stylesheet><script src=/farmer/js/jquery-3.3.1.min.js?1757294257></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/farmer/tutorials/keyvault-certs/><nav id=sidebar><div id=header-wrapper><div id=header><img src=/farmer/images/logo.png></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label><input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/farmer/js/lunr.min.js?1757294257></script><script type=text/javascript src=/farmer/js/auto-complete.js?1757294257></script><script type=text/javascript>var baseurl="https:\/\/compositionalit.github.io\/farmer\/";</script><script type=text/javascript src=/farmer/js/search.js?1757294257></script></div><div class=highlightable><ul class=topics><li data-nav-id=/farmer/about/ title=About class=dd-item><a href=/farmer/about/>About</a></li><li data-nav-id=/farmer/quickstarts/ title=Quickstarts class=dd-item><a href=/farmer/quickstarts/>Quickstarts</a><ul><li data-nav-id=/farmer/quickstarts/quickstart-1/ title="Your first Farmer template" class=dd-item><a href=/farmer/quickstarts/quickstart-1/>Your first Farmer template</a></li><li data-nav-id=/farmer/quickstarts/quickstart-2/ title="Working with multiple resources" class=dd-item><a href=/farmer/quickstarts/quickstart-2/>Working with multiple resources</a></li><li data-nav-id=/farmer/quickstarts/quickstart-3/ title="Deploying to Azure" class=dd-item><a href=/farmer/quickstarts/quickstart-3/>Deploying to Azure</a></li><li data-nav-id=/farmer/quickstarts/template/ title="The Farmer .NET Template" class=dd-item><a href=/farmer/quickstarts/template/>The Farmer .NET Template</a></li></ul></li><li data-nav-id=/farmer/tutorials/ title=Tutorials class="dd-item
parent"><a href=/farmer/tutorials/>Tutorials</a><ul><li data-nav-id=/farmer/tutorials/traditional-ea/ title="Traditional Enterprise Application to the Azure Cloud, managed via Farmer" class=dd-item><a href=/farmer/tutorials/traditional-ea/>Traditional Enterprise Application to the Azure Cloud, managed via Farmer</a></li><li data-nav-id=/farmer/tutorials/webapp-deploy/ title="Deploy an ASP.NET app" class=dd-item><a href=/farmer/tutorials/webapp-deploy/>Deploy an ASP.NET app</a></li><li data-nav-id=/farmer/tutorials/custom-output/ title="Custom Output with ARM Expressions" class=dd-item><a href=/farmer/tutorials/custom-output/>Custom Output with ARM Expressions</a></li><li data-nav-id=/farmer/tutorials/keyvault-certs/ title="Declarative Steps in an ARM Deployment" class="dd-item active"><a href=/farmer/tutorials/keyvault-certs/>Declarative Steps in an ARM Deployment</a></li><li data-nav-id=/farmer/tutorials/minecraft-server-aci/ title="Create your own Minecraft Server" class=dd-item><a href=/farmer/tutorials/minecraft-server-aci/>Create your own Minecraft Server</a></li><li data-nav-id=/farmer/tutorials/aci-fsx/ title="F# Script in a Container Group" class=dd-item><a href=/farmer/tutorials/aci-fsx/>F# Script in a Container Group</a></li><li data-nav-id=/farmer/tutorials/cosmos-backed-webapp/ title="Cosmos-backed Web App" class=dd-item><a href=/farmer/tutorials/cosmos-backed-webapp/>Cosmos-backed Web App</a></li><li data-nav-id=/farmer/tutorials/multiple-web-apps/ title="Multiple web apps" class=dd-item><a href=/farmer/tutorials/multiple-web-apps/>Multiple web apps</a></li><li data-nav-id=/farmer/tutorials/serverless-etl/ title="Serverless ETL" class=dd-item><a href=/farmer/tutorials/serverless-etl/>Serverless ETL</a></li><li data-nav-id=/farmer/tutorials/web-storage-keyvault/ title="Web App Secrets with KeyVault" class=dd-item><a href=/farmer/tutorials/web-storage-keyvault/>Web App Secrets with KeyVault</a></li></ul></li><li data-nav-id=/farmer/api-overview/ title="API Overview" class=dd-item><a href=/farmer/api-overview/>API Overview</a><ul><li data-nav-id=/farmer/api-overview/template-generation/ title="Generating templates" class=dd-item><a href=/farmer/api-overview/template-generation/>Generating templates</a></li><li data-nav-id=/farmer/api-overview/expressions/ title="ARM Expressions" class=dd-item><a href=/farmer/api-overview/expressions/>ARM Expressions</a></li><li data-nav-id=/farmer/api-overview/parameters/ title="Parameters and Variables" class=dd-item><a href=/farmer/api-overview/parameters/>Parameters and Variables</a></li><li data-nav-id=/farmer/api-overview/basic-types/ title="Basic Types" class=dd-item><a href=/farmer/api-overview/basic-types/>Basic Types</a></li><li data-nav-id=/farmer/api-overview/dependencies/ title=Dependencies class=dd-item><a href=/farmer/api-overview/dependencies/>Dependencies</a></li><li data-nav-id=/farmer/api-overview/outputs/ title=Outputs class=dd-item><a href=/farmer/api-overview/outputs/>Outputs</a></li><li data-nav-id=/farmer/api-overview/resources/ title=Resources class=dd-item><a href=/farmer/api-overview/resources/>Resources</a><ul><li data-nav-id=/farmer/api-overview/resources/prometheus-rule-group/ title="Alert Management - Prometheus Rule Groups" class=dd-item><a href=/farmer/api-overview/resources/prometheus-rule-group/>Alert Management - Prometheus Rule Groups</a></li><li data-nav-id=/farmer/api-overview/resources/data-collection/ title="Azure Monitor - Data Collection" class=dd-item><a href=/farmer/api-overview/resources/data-collection/>Azure Monitor - Data Collection</a></li><li data-nav-id=/farmer/api-overview/resources/b2c-tenant/ title="B2C Tenant" class=dd-item><a href=/farmer/api-overview/resources/b2c-tenant/>B2C Tenant</a></li><li data-nav-id=/farmer/api-overview/resources/action-group/ title="App Insights - Action Group" class=dd-item><a href=/farmer/api-overview/resources/action-group/>App Insights - Action Group</a></li><li data-nav-id=/farmer/api-overview/resources/application-gateway/ title="Application Gateway" class=dd-item><a href=/farmer/api-overview/resources/application-gateway/>Application Gateway</a></li><li data-nav-id=/farmer/api-overview/resources/alert/ title="App Insights - Alerts" class=dd-item><a href=/farmer/api-overview/resources/alert/>App Insights - Alerts</a></li><li data-nav-id=/farmer/api-overview/resources/availability-tests/ title="App Insights - Availability Tests" class=dd-item><a href=/farmer/api-overview/resources/availability-tests/>App Insights - Availability Tests</a></li><li data-nav-id=/farmer/api-overview/resources/azure-firewall/ title="Azure Firewall" class=dd-item><a href=/farmer/api-overview/resources/azure-firewall/>Azure Firewall</a></li><li data-nav-id=/farmer/api-overview/resources/aks-cluster/ title="AKS Cluster" class=dd-item><a href=/farmer/api-overview/resources/aks-cluster/>AKS Cluster</a></li><li data-nav-id=/farmer/api-overview/resources/app-insights/ title="App Insights" class=dd-item><a href=/farmer/api-overview/resources/app-insights/>App Insights</a></li><li data-nav-id=/farmer/api-overview/resources/bing-search/ title="Bing Search" class=dd-item><a href=/farmer/api-overview/resources/bing-search/>Bing Search</a></li><li data-nav-id=/farmer/api-overview/resources/bastion-host/ title="Bastion Host" class=dd-item><a href=/farmer/api-overview/resources/bastion-host/>Bastion Host</a></li><li data-nav-id=/farmer/api-overview/resources/container-apps/ title="Container Apps" class=dd-item><a href=/farmer/api-overview/resources/container-apps/>Container Apps</a></li><li data-nav-id=/farmer/api-overview/resources/communication-services/ title="Communication Services" class=dd-item><a href=/farmer/api-overview/resources/communication-services/>Communication Services</a></li><li data-nav-id=/farmer/api-overview/resources/container-group/ title="Container Group" class=dd-item><a href=/farmer/api-overview/resources/container-group/>Container Group</a></li><li data-nav-id=/farmer/api-overview/resources/container-registry/ title="Container Registry" class=dd-item><a href=/farmer/api-overview/resources/container-registry/>Container Registry</a></li><li data-nav-id=/farmer/api-overview/resources/cognitive-services/ title="Cognitive Services" class=dd-item><a href=/farmer/api-overview/resources/cognitive-services/>Cognitive Services</a></li><li data-nav-id=/farmer/api-overview/resources/cosmos-db/ title="Cosmos DB" class=dd-item><a href=/farmer/api-overview/resources/cosmos-db/>Cosmos DB</a></li><li data-nav-id=/farmer/api-overview/resources/cdn/ title=CDN class=dd-item><a href=/farmer/api-overview/resources/cdn/>CDN</a></li><li data-nav-id=/farmer/api-overview/resources/dns-resolver/ title="DNS Resolver" class=dd-item><a href=/farmer/api-overview/resources/dns-resolver/>DNS Resolver</a></li><li data-nav-id=/farmer/api-overview/resources/dashboard/ title=Dashboard class=dd-item><a href=/farmer/api-overview/resources/dashboard/>Dashboard</a></li><li data-nav-id=/farmer/api-overview/resources/databricks-workspace/ title="Databricks Workspace" class=dd-item><a href=/farmer/api-overview/resources/databricks-workspace/>Databricks Workspace</a></li><li data-nav-id=/farmer/api-overview/resources/deployment-script/ title="Deployment Script" class=dd-item><a href=/farmer/api-overview/resources/deployment-script/>Deployment Script</a></li><li data-nav-id=/farmer/api-overview/resources/dns/ title="DNS Zone" class=dd-item><a href=/farmer/api-overview/resources/dns/>DNS Zone</a></li><li data-nav-id=/farmer/api-overview/resources/data-lake/ title="Data Lake" class=dd-item><a href=/farmer/api-overview/resources/data-lake/>Data Lake</a></li><li data-nav-id=/farmer/api-overview/resources/diagnosticsetting/ title="Diagnostic Settings" class=dd-item><a href=/farmer/api-overview/resources/diagnosticsetting/>Diagnostic Settings</a></li><li data-nav-id=/farmer/api-overview/resources/dedicated-hosts/ title="Dedicated Hosts" class=dd-item><a href=/farmer/api-overview/resources/dedicated-hosts/>Dedicated Hosts</a></li><li data-nav-id=/farmer/api-overview/resources/route-tables/ title="Route Tables" class=dd-item><a href=/farmer/api-overview/resources/route-tables/>Route Tables</a></li><li data-nav-id=/farmer/api-overview/resources/nat-gateway/ title="NAT Gateway" class=dd-item><a href=/farmer/api-overview/resources/nat-gateway/>NAT Gateway</a></li><li data-nav-id=/farmer/api-overview/resources/event-grid/ title="Event Grid" class=dd-item><a href=/farmer/api-overview/resources/event-grid/>Event Grid</a></li><li data-nav-id=/farmer/api-overview/resources/express-route/ title=ExpressRoute class=dd-item><a href=/farmer/api-overview/resources/express-route/>ExpressRoute</a></li><li data-nav-id=/farmer/api-overview/resources/event-hub/ title="Event Hub" class=dd-item><a href=/farmer/api-overview/resources/event-hub/>Event Hub</a></li><li data-nav-id=/farmer/api-overview/resources/network-interface/ title="Network Interface" class=dd-item><a href=/farmer/api-overview/resources/network-interface/>Network Interface</a></li><li data-nav-id=/farmer/api-overview/resources/route-server/ title="Route Server" class=dd-item><a href=/farmer/api-overview/resources/route-server/>Route Server</a></li><li data-nav-id=/farmer/api-overview/resources/functions/ title=Functions class=dd-item><a href=/farmer/api-overview/resources/functions/>Functions</a></li><li data-nav-id=/farmer/api-overview/resources/iot-hub/ title="IOT Hub" class=dd-item><a href=/farmer/api-overview/resources/iot-hub/>IOT Hub</a></li><li data-nav-id=/farmer/api-overview/resources/gallery/ title=Gallery class=dd-item><a href=/farmer/api-overview/resources/gallery/>Gallery</a></li><li data-nav-id=/farmer/api-overview/resources/image-template/ title="Image Template" class=dd-item><a href=/farmer/api-overview/resources/image-template/>Image Template</a></li><li data-nav-id=/farmer/api-overview/resources/keyvault/ title="Key Vault" class=dd-item><a href=/farmer/api-overview/resources/keyvault/>Key Vault</a></li><li data-nav-id=/farmer/api-overview/resources/private-endpoint/ title="Private Endpoint" class=dd-item><a href=/farmer/api-overview/resources/private-endpoint/>Private Endpoint</a></li><li data-nav-id=/farmer/api-overview/resources/private-link-service/ title="Private Link Service" class=dd-item><a href=/farmer/api-overview/resources/private-link-service/>Private Link Service</a></li><li data-nav-id=/farmer/api-overview/resources/logic-apps/ title="Logic Apps" class=dd-item><a href=/farmer/api-overview/resources/logic-apps/>Logic Apps</a></li><li data-nav-id=/farmer/api-overview/resources/load-balancer/ title="Load Balancer" class=dd-item><a href=/farmer/api-overview/resources/load-balancer/>Load Balancer</a></li><li data-nav-id=/farmer/api-overview/resources/loganalytics/ title="Log Analytics" class=dd-item><a href=/farmer/api-overview/resources/loganalytics/>Log Analytics</a></li><li data-nav-id=/farmer/api-overview/resources/managed-identity/ title="Managed Identity" class=dd-item><a href=/farmer/api-overview/resources/managed-identity/>Managed Identity</a></li><li data-nav-id=/farmer/api-overview/resources/maps/ title=Maps class=dd-item><a href=/farmer/api-overview/resources/maps/>Maps</a></li><li data-nav-id=/farmer/api-overview/resources/nsg/ title="Network Security Group" class=dd-item><a href=/farmer/api-overview/resources/nsg/>Network Security Group</a></li><li data-nav-id=/farmer/api-overview/resources/operations-management/ title="Operations Management" class=dd-item><a href=/farmer/api-overview/resources/operations-management/>Operations Management</a></li><li data-nav-id=/farmer/api-overview/resources/postgresql/ title=PostgreSQL class=dd-item><a href=/farmer/api-overview/resources/postgresql/>PostgreSQL</a></li><li data-nav-id=/farmer/api-overview/resources/redis/ title="Redis Cache" class=dd-item><a href=/farmer/api-overview/resources/redis/>Redis Cache</a></li><li data-nav-id=/farmer/api-overview/resources/resource-group/ title="Resource Group" class=dd-item><a href=/farmer/api-overview/resources/resource-group/>Resource Group</a></li><li data-nav-id=/farmer/api-overview/resources/signalr/ title=SignalR class=dd-item><a href=/farmer/api-overview/resources/signalr/>SignalR</a></li><li data-nav-id=/farmer/api-overview/resources/search/ title=Search class=dd-item><a href=/farmer/api-overview/resources/search/>Search</a></li><li data-nav-id=/farmer/api-overview/resources/service-bus/ title="Service Bus" class=dd-item><a href=/farmer/api-overview/resources/service-bus/>Service Bus</a></li><li data-nav-id=/farmer/api-overview/resources/sql/ title="SQL Azure" class=dd-item><a href=/farmer/api-overview/resources/sql/>SQL Azure</a></li><li data-nav-id=/farmer/api-overview/resources/static-web-app/ title="Static Web Apps" class=dd-item><a href=/farmer/api-overview/resources/static-web-app/>Static Web Apps</a></li><li data-nav-id=/farmer/api-overview/resources/storage-account/ title="Storage Account" class=dd-item><a href=/farmer/api-overview/resources/storage-account/>Storage Account</a></li><li data-nav-id=/farmer/api-overview/resources/traffic-manager/ title="Traffic Manager" class=dd-item><a href=/farmer/api-overview/resources/traffic-manager/>Traffic Manager</a></li><li data-nav-id=/farmer/api-overview/resources/virtual-machine/ title="Virtual Machine" class=dd-item><a href=/farmer/api-overview/resources/virtual-machine/>Virtual Machine</a></li><li data-nav-id=/farmer/api-overview/resources/virtual-hub/ title="Virtual Hub" class=dd-item><a href=/farmer/api-overview/resources/virtual-hub/>Virtual Hub</a></li><li data-nav-id=/farmer/api-overview/resources/vnet/ title="Virtual Network" class=dd-item><a href=/farmer/api-overview/resources/vnet/>Virtual Network</a></li><li data-nav-id=/farmer/api-overview/resources/virtual-wan/ title="Virtual WAN" class=dd-item><a href=/farmer/api-overview/resources/virtual-wan/>Virtual WAN</a></li><li data-nav-id=/farmer/api-overview/resources/vnet-gateway/ title="Virtual Network Gateway" class=dd-item><a href=/farmer/api-overview/resources/vnet-gateway/>Virtual Network Gateway</a></li><li data-nav-id=/farmer/api-overview/resources/vm-scale-set/ title="Virtual Machine Scale Set" class=dd-item><a href=/farmer/api-overview/resources/vm-scale-set/>Virtual Machine Scale Set</a></li><li data-nav-id=/farmer/api-overview/resources/disk/ title=Disk class=dd-item><a href=/farmer/api-overview/resources/disk/>Disk</a></li><li data-nav-id=/farmer/api-overview/resources/web-app/ title="Web App" class=dd-item><a href=/farmer/api-overview/resources/web-app/>Web App</a></li><li data-nav-id=/farmer/api-overview/resources/autoscale-settings/ title="Autoscale Settings" class=dd-item><a href=/farmer/api-overview/resources/autoscale-settings/>Autoscale Settings</a></li></ul></li></ul></li><li data-nav-id=/farmer/arm-vs-farmer/ title="Farmer and ARM" class=dd-item><a href=/farmer/arm-vs-farmer/>Farmer and ARM</a></li><li data-nav-id=/farmer/deployment-guidance/ title="Deployment Guidance" class=dd-item><a href=/farmer/deployment-guidance/>Deployment Guidance</a></li><li data-nav-id=/farmer/support/ title="Commercial Support" class=dd-item><a href=/farmer/support/>Commercial Support</a></li><li data-nav-id=/farmer/testimonials/ title=Testimonials class=dd-item><a href=/farmer/testimonials/>Testimonials</a></li><li data-nav-id=/farmer/links/ title=Links class=dd-item><a href=/farmer/links/>Links</a></li><li data-nav-id=/farmer/contributing/ title=Contributing class=dd-item><a href=/farmer/contributing/>Contributing</a><ul><li data-nav-id=/farmer/contributing/arm-basics/ title="ARM Basics" class=dd-item><a href=/farmer/contributing/arm-basics/>ARM Basics</a></li><li data-nav-id=/farmer/contributing/outputs-and-expressions/ title="Outputs and ARM Expressions" class=dd-item><a href=/farmer/contributing/outputs-and-expressions/>Outputs and ARM Expressions</a></li><li data-nav-id=/farmer/contributing/create-pull-requests/ title="Creating Pull Requests" class=dd-item><a href=/farmer/contributing/create-pull-requests/>Creating Pull Requests</a></li><li data-nav-id=/farmer/contributing/adding-resources/ title="Supporting a new ARM Resource" class=dd-item><a href=/farmer/contributing/adding-resources/>Supporting a new ARM Resource</a><ul><li data-nav-id=/farmer/contributing/adding-resources/1-the-farmer-pipline/ title="1. The Farmer Pipeline" class=dd-item><a href=/farmer/contributing/adding-resources/1-the-farmer-pipline/>1. The Farmer Pipeline</a></li><li data-nav-id=/farmer/contributing/adding-resources/2-iarm-resource/ title="2. The IArmResource" class=dd-item><a href=/farmer/contributing/adding-resources/2-iarm-resource/>2. The IArmResource</a></li><li data-nav-id=/farmer/contributing/adding-resources/3-ibuilder/ title="3. The IBuilder interface" class=dd-item><a href=/farmer/contributing/adding-resources/3-ibuilder/>3. The IBuilder interface</a></li><li data-nav-id=/farmer/contributing/adding-resources/4-creating-builder-syntax/ title="4. Providing Builder syntax" class=dd-item><a href=/farmer/contributing/adding-resources/4-creating-builder-syntax/>4. Providing Builder syntax</a></li><li data-nav-id=/farmer/contributing/adding-resources/5-unit-testing/ title="5. Unit Testing" class=dd-item><a href=/farmer/contributing/adding-resources/5-unit-testing/>5. Unit Testing</a></li></ul></li></ul></li><li data-nav-id=/farmer/faq/ title=FAQs class=dd-item><a href=/farmer/faq/>FAQs</a></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://github.com/compositionalit/farmer><i class="fab fa-fw fa-github"></i>GitHub repo</a></li><li><a class=padding href=https://www.nuget.org/packages/Farmer/><i class="fab fa-fw fa-microsoft"></i>Nuget</a></li><li><a class=padding href=https://compositional-it.com><img src=/farmer/images/cit.png></img> Compositional IT</a></li></ul></section><section id=footer></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/CompositionalIT/farmer/tree/master/docs/content/tutorials/keyvault-certs.md target=blank><i class="fas fa-code-branch"></i><span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span><span class=links><a href=/farmer/>Farmer</a> > <a href=/farmer/tutorials/>Tutorials</a> > Declarative Steps in an ARM Deployment</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><ul><li></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Declarative Steps in an ARM Deployment</h1><h4 id=introduction>Introduction</h4><p>An ARM deployment typically represents the infrastructure you want deployed as a result of it, referred to as the &ldquo;goal state&rdquo;. For instance, you may want to have a web application with a database, so you&rsquo;ll define your goal state that includes database and web application resources. However, it&rsquo;s not always that simple - there are various reasons that some of the steps of a deployment cannot be represented by the goal state resource model.</p><ul><li>Creating a backup of a database before a deployment.</li><li>Interacting with API&rsquo;s that aren&rsquo;t represented in ARM itself (Kubernetes control plane, networking devices, or the API&rsquo;s of the application you&rsquo;re deploying).</li><li>Performing ARM <em>operations</em> such as creating a certificate.</li></ul><p>In any of these scenarios, there is some imperative logic that needs to be included in the ARM deployment. To keep the ARM deployment itself repeatable, it&rsquo;s often best to ensure this imperative logic is idempotent - that is, it can run repeatedly without incurring side effects.</p><p>In this tutorial, we will handle the third case, running an ARM operation to create a certificate in a key vault. We&rsquo;ll create a <code>deploymentScript</code> resource for this, which creates a temporary ARM resource for the purposes of executing this imperative logic.</p><ol><li>Create a user assigned identity.</li><li>Create a storage account for making the certificate available to the web app.</li><li>Create a key vault for generating the certificate.</li><li>Run an imperative script to create a certificate in the key vault and copy it to the storage account.</li><li>Create a web application in a container group that attaches to the storage account to uses the certificate.</li></ol><figure><img src=../../images/tutorials/imperative-resource.png alt="Full code available here"><figcaption><p><a href=https://github.com/CompositionalIT/farmer/blob/master/samples/scripts/tutorials/keyvault-certs.fsx>Full code available here</a></p></figcaption></figure><h4 id=create-a-user-assigned-identity>Create a user assigned identity</h4><p>A deployment script runs in a temporary container group and needs an identity, as does the container group. This identity will be a contributor over the resources in the resource group where this deployment runs so that it has permissions to upload the certificate to the storage account.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#66d9ef>let</span> appIdentity <span style=color:#f92672>=</span> userAssignedIdentity <span style=color:#f92672>{</span>
    name <span style=color:#e6db74>&#34;my-app-user&#34;</span>
<span style=color:#f92672>}</span>
</code></pre></div><h4 id=create-the-certificate-storage-account>Create the Certificate Storage Account</h4><p>Depending on the type of compute resource used, you may be able to retrieve the certificate directly from the key vault on startup. However, for a container group, a good solution is to have a file share on a storage account. After creating the certificate, we will download it from the key vault and upload it to this storage account file share to make it available to the container group.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#66d9ef>let</span> certStorage <span style=color:#f92672>=</span> storageAccount <span style=color:#f92672>{</span>
    name <span style=color:#e6db74>&#34;myappcertstorage123&#34;</span>
    sku Storage.Sku.Standard_LRS
    add_file_share <span style=color:#e6db74>&#34;certs&#34;</span>
<span style=color:#f92672>}</span>
</code></pre></div><h4 id=create-the-key-vault>Create the Key Vault</h4><p>We need to create a key vault to generate the certificate. When a certificate is created in a key vault, the public key is stored as a certificate and the full certificate with private and public key is stored as a secret of the same name. To enable this access, we will need to define an <code>accessPolicy</code> on the key vault that allows our <code>appIdentity</code> to create and retrieve certificates and secrets.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#66d9ef>let</span> kv <span style=color:#f92672>=</span> keyVault <span style=color:#f92672>{</span>
    name <span style=color:#e6db74>&#34;myappcertificates&#34;</span>
    add_access_policies <span style=color:#f92672>[</span>
        accessPolicy <span style=color:#f92672>{</span>
            object_id appIdentity<span style=color:#f92672>.</span>PrincipalId
            secret_permissions <span style=color:#f92672>[</span> KeyVault.Secret.Set<span style=color:#f92672>;</span> KeyVault.Secret.Get <span style=color:#f92672>]</span>
            certificate_permissions <span style=color:#f92672>[</span> KeyVault.Certificate.Create<span style=color:#f92672>;</span> KeyVault.Certificate.Get <span style=color:#f92672>]</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>]</span>
<span style=color:#f92672>}</span>
</code></pre></div><h4 id=the-imperative-part-creating-the-certificate>The Imperative Part: Creating the Certificate</h4><p>Creating a certificate is an imperative operation because this is a multiple step process where a key pair is created, then a certificate signing request is created from the key pair and signed by a certificate authority. Certificates can also be &ldquo;self-signed&rdquo;, meaning they have no certificate authority and must be individually trusted. This whole process means you cannot simply repeat it without side effects, so it is represented in ARM as an <em>operation</em> rather than a resource.</p><p>Creating a certificate in an Azure key vault requires that you provide a policy for the certificate which defines the various settings such as the key size, issuer, and subject name (what identifies the host when presenting the certificate).</p><p>You can use the default policy directly, but this doesn&rsquo;t let you set the subject name, so instead, we will build our own policy. To get a reference on what a valid policy contains, use the following Azure CLI command to &ldquo;scaffold&rdquo; a policy:</p><p><code>az keyvault certificate get-default-policy --scaffold</code></p><p>We want a policy.json that roughly matches this, with a few adjustments for our scenario. F# anonymous records are very handy for creating JSON directly, so we&rsquo;ll use one here to create a policy JSON string similar to the scaffold. Because we need to embed this in our ARM template so it can run in the deployment script, we&rsquo;ll convert it to base64 and avoid any issues with trying to embed JSON in another JSON file.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#66d9ef>let</span> policy <span style=color:#f92672>=</span>
    <span style=color:#f92672>{|</span>
        keyProperties <span style=color:#f92672>=</span>
            <span style=color:#f92672>{|</span>
                exportable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
                keyType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;RSA&#34;</span>
                keySize <span style=color:#f92672>=</span> 2048
                reuseKey <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
            <span style=color:#f92672>|}</span>
        secretProperties <span style=color:#f92672>=</span>
            <span style=color:#f92672>{|</span>
                contentType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;application/x-pkcs12&#34;</span>
            <span style=color:#f92672>|}</span>
        x509CertificateProperties <span style=color:#f92672>=</span>
            <span style=color:#f92672>{|</span>
                subject <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;CN=my-web-app.eastus.azurecontainer.io&#34;</span>
                subjectAlternativeNames <span style=color:#f92672>=</span>
                    <span style=color:#f92672>{|</span>
                        dnsNames <span style=color:#f92672>=</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;my-web-app.eastus.azurecontainer.io&#34;</span> <span style=color:#f92672>]</span>
                    <span style=color:#f92672>|}</span>
            <span style=color:#f92672>|}</span>
        issuerParameters <span style=color:#f92672>=</span>
            <span style=color:#f92672>{|</span>
                name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Self&#34;</span>
            <span style=color:#f92672>|}</span>
    <span style=color:#f92672>|}</span>
<span style=color:#66d9ef>let</span> policyJsonB64 <span style=color:#f92672>=</span>
    policy
    <span style=color:#f92672>|&gt;</span> System.Text.Json.JsonSerializer.Serialize <span style=color:#75715e>// serialize to JSON
</span><span style=color:#75715e></span>    <span style=color:#f92672>|&gt;</span> System.Text.Encoding.UTF8.GetBytes <span style=color:#75715e>// and then encode it for easy embedding
</span><span style=color:#75715e></span>    <span style=color:#f92672>|&gt;</span> System.Convert.ToBase64String
</code></pre></div><p>Now for the deployment script itself. This will run the Azure CLI within a temporary container. It needs to perform the following steps:</p><ol><li>Take the embedded base64 policy.json string and write it to the file system where the deployment script runs.</li><li>Create a certificate, using that policy.json file.</li><li>Download the secret containing the public and private key pair in a .pfx file.</li><li>Upload the .pfx file to the storage account file share to make it available to the container group.</li></ol><p>The string interpolation in F# 5.0 is very handy for embedding F# values in the bash script statements.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#66d9ef>let</span> script <span style=color:#f92672>=</span>
    <span style=color:#f92672>[</span>
    <span style=color:#e6db74>&#34;set -e&#34;</span>
    <span style=color:#75715e>// Write the encoded policy to a file in the deployment script resource.
</span><span style=color:#75715e></span>    <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;echo {policyJsonB64} | base64 -d &gt; policy.json&#34;</span>
    <span style=color:#75715e>// Run imperative az CLI commands to create the certificate.
</span><span style=color:#75715e></span>    <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;az keyvault certificate create --vault-name {kv.Name.Value} -n my-app-cert -p @policy.json&#34;</span>
    <span style=color:#75715e>// Download the cert
</span><span style=color:#75715e></span>    <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;az keyvault certificate download --file cert.pem --vault-name {kv.Name.Value} -n my-app-cert&#34;</span>
    <span style=color:#75715e>// Download the pfx with cert and private key
</span><span style=color:#75715e></span>    <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;az keyvault secret show --vault-name {kv.Name.Value} -n my-app-cert | jq .value -r | base64 -d &gt; key.pfx&#34;</span>
    <span style=color:#75715e>// Upload to storage file
</span><span style=color:#75715e></span>    <span style=color:#f92672>$</span><span style=color:#e6db74>&#34;az storage file upload --account-name {certStorage.Name.ResourceName.Value} --share-name certs --source key.pfx&#34;</span>
    <span style=color:#f92672>]</span> <span style=color:#f92672>|&gt;</span> String.concat <span style=color:#e6db74>&#34;;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
</code></pre></div><p>With the hard part out of the way, we can define the <code>deploymentScript</code> resource, which is a temporary ARM resource that represents running these imperative steps. Because we don&rsquo;t want this to run until the key vault and storage account are available, we need to use <code>depends_on</code> and reference these two resources. Also, notice this uses the <code>appIdentity</code> that was granted access to the key vault secrets and certificates.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp>deploymentScript <span style=color:#f92672>{</span>
    name <span style=color:#e6db74>&#34;create-certificate&#34;</span>
    identity appIdentity
    depends_on kv
    depends_on certStorage
    force_update
    cleanup_on_success
    retention_interval 1<span style=color:#f92672>&lt;</span>Hours<span style=color:#f92672>&gt;</span>
    script_content script
<span style=color:#f92672>}</span>
</code></pre></div><h4 id=creating-the-web-application>Creating the Web Application</h4><p>Our web application will be a simple &ldquo;hello world&rdquo; service, as the interesting part is that it listens on HTTPS. Doing this requires the key pair to be loaded by the service when it creates the binding to an HTTPS port. Here is the script content. Notice we need to add the certificate to the <code>X509Store</code>. This avoids some SSL warnings within the service itself due to using a self-signed certificate. If you are using a trusted third party CA, this may not be necessary.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#f92672>#</span>r <span style=color:#e6db74>&#34;nuget: Suave, Version=2.6.0&#34;</span>

<span style=color:#66d9ef>open</span> Suave
<span style=color:#66d9ef>open</span> System.Security.Cryptography.X509Certificates

<span style=color:#66d9ef>let</span> certWithKey <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> X509Certificate2<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/certs/key.pfx&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>let</span> store <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> X509Store<span style=color:#f92672>(</span>StoreName.Root<span style=color:#f92672>,</span> StoreLocation.CurrentUser<span style=color:#f92672>)</span>
store<span style=color:#f92672>.</span>Open<span style=color:#f92672>(</span>OpenFlags.ReadWrite<span style=color:#f92672>)</span>
store<span style=color:#f92672>.</span>Add<span style=color:#f92672>(</span>certWithKey<span style=color:#f92672>)</span>
store<span style=color:#f92672>.</span>Close()

<span style=color:#66d9ef>let</span> config <span style=color:#f92672>=</span> <span style=color:#f92672>{</span> defaultConfig <span style=color:#66d9ef>with</span> bindings <span style=color:#f92672>=</span> <span style=color:#f92672>[</span> HttpBinding.createSimple <span style=color:#f92672>(</span>HTTPS certWithKey<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;0.0.0.0&#34;</span> 443 <span style=color:#f92672>]</span> <span style=color:#f92672>}</span>
startWebServer config <span style=color:#f92672>(</span>Successful.OK <span style=color:#e6db74>&#34;Hello Secure Farmers!&#34;</span><span style=color:#f92672>)</span>
</code></pre></div><p>We will read this short script into a string that we can pass to our container group. In real life, you probably have a full application published in a container image, but for illustrative purposes, we are just embedding the script.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#66d9ef>let</span> webAppMain <span style=color:#f92672>=</span> System.IO.File.ReadAllText <span style=color:#e6db74>&#34;keyvault-certs-app.fsx&#34;</span>
</code></pre></div><p>Now we create the container group. It uses a .NET 5.0 SDK image to run the script and has two volume mounts. One is for the embedded script itself, and the other is for the volume mount from the Azure storage account file share where the certificate itself is stored.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#66d9ef>let</span> webApp <span style=color:#f92672>=</span> containerGroup <span style=color:#f92672>{</span>
    name <span style=color:#e6db74>&#34;my-web-app&#34;</span>
    add_identity appIdentity
    add_instances <span style=color:#f92672>[</span>
        containerInstance <span style=color:#f92672>{</span>
            name <span style=color:#e6db74>&#34;fsi&#34;</span>
            image <span style=color:#e6db74>&#34;mcr.microsoft.com/dotnet/sdk:5.0&#34;</span>
            command_line <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;dotnet fsi /src/main.fsx&#34;</span><span style=color:#f92672>.</span>Split <span style=color:#66d9ef>null</span> <span style=color:#f92672>|&gt;</span> List.ofArray<span style=color:#f92672>)</span>
            add_volume_mount <span style=color:#e6db74>&#34;script-source&#34;</span> <span style=color:#e6db74>&#34;/src&#34;</span>
            add_volume_mount <span style=color:#e6db74>&#34;cert-volume&#34;</span> <span style=color:#e6db74>&#34;/certs&#34;</span>
            add_public_ports <span style=color:#f92672>[</span> 443us <span style=color:#f92672>]</span>
            cpu_cores 0<span style=color:#f92672>.</span>2
            memory 0<span style=color:#f92672>.</span>5<span style=color:#f92672>&lt;</span>Gb<span style=color:#f92672>&gt;</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>]</span>
    public_dns <span style=color:#e6db74>&#34;my-web-app&#34;</span> <span style=color:#f92672>[</span> TCP<span style=color:#f92672>,</span> 443us <span style=color:#f92672>]</span>
    add_volumes <span style=color:#f92672>[</span>
        volume_mount<span style=color:#f92672>.</span>secret_string <span style=color:#e6db74>&#34;script-source&#34;</span> <span style=color:#e6db74>&#34;main.fsx&#34;</span> webAppMain
        volume_mount<span style=color:#f92672>.</span>azureFile <span style=color:#e6db74>&#34;cert-volume&#34;</span> <span style=color:#e6db74>&#34;certs&#34;</span> certStorage<span style=color:#f92672>.</span>Name<span style=color:#f92672>.</span>ResourceName<span style=color:#f92672>.</span>Value
    <span style=color:#f92672>]</span>
<span style=color:#f92672>}</span>
</code></pre></div><h4 id=the-arm-template>The ARM Template</h4><p>With all of these resources, we can create an ARM template. It contains four declarative resources: the user assigned identity, a key vault, a storage account, and a container group. It also contains a deployment script resource for the imperative logic.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp>arm <span style=color:#f92672>{</span>
    location Location.EastUS
    add_resources <span style=color:#f92672>[</span>
        appIdentity
        kv
        certStorage
        createCertificate
        webApp
    <span style=color:#f92672>]</span>
<span style=color:#f92672>}</span> <span style=color:#f92672>|&gt;</span> Writer.quickWrite <span style=color:#e6db74>&#34;keyvault-certs&#34;</span>
</code></pre></div><p>Deploying the resulting template through ARM will result in ARM attempting to reach the goal state with as much concurrency as dependencies allow. It will deploy the user assigned identity first, then both the key vault and the storage account at the same time, and then finally it will run the deployment script and deploy the container group.</p><p>The end result is a container group running an HTTPS service using a certificate that was created in the newly provisioned key vault.</p><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=/farmer/tutorials/custom-output/ title="Custom Output with ARM Expressions"><i class="fa fa-chevron-left"></i></a><a class="nav nav-next" href=/farmer/tutorials/minecraft-server-aci/ title="Create your own Minecraft Server" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/farmer/js/clipboard.min.js?1757294258></script><script src=/farmer/js/perfect-scrollbar.min.js?1757294258></script><script src=/farmer/js/perfect-scrollbar.jquery.min.js?1757294258></script><script src=/farmer/js/jquery.sticky.js?1757294258></script><script src=/farmer/js/featherlight.min.js?1757294258></script><script src=/farmer/js/highlight.pack.js?1757294258></script><script>hljs.initHighlightingOnLoad();</script><script src=/farmer/js/modernizr.custom-3.6.0.js?1757294258></script><script src=/farmer/js/learn.js?1757294258></script><script src=/farmer/js/hugo-learn.js?1757294258></script><link href=/farmer/mermaid/mermaid.css?1757294258 rel=stylesheet><script src=/farmer/mermaid/mermaid.js?1757294258></script><script>mermaid.initialize({startOnLoad:true});</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-72817248-3','auto');ga('send','pageview');</script></body></html>